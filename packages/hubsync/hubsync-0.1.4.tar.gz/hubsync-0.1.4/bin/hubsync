#!/usr/bin/env python

import os
import logging
import argparse
import ConfigParser

from hubsync import github, workspace, sync


LOG = logging.getLogger('hubsync')
LOG.setLevel(logging.INFO)
LOG.addHandler(logging.StreamHandler())

if __name__ == "__main__":
    config = ConfigParser.ConfigParser(defaults={
        'api_url': 'https://api.github.com',
        'token': None
    })
    config.read(os.path.expanduser('~/.hubsyncrc'))
    if not config.has_section('github'):
        config.add_section('github')

    parser = argparse.ArgumentParser(description="Keeps your repos in sync! "
                                                 "Note: Reads defaults from "
                                                 "~/.hubsyncrc")
    parser.add_argument('--github_api_url', type=str,
                        required=not config.get('github', 'api_url'),
                        default=config.get('github', 'api_url'))
    parser.add_argument('--github_token', type=str,
                        required=not config.get('github', 'token'),
                        default=config.get('github', 'token'))
    args = parser.parse_args()

    api_args = {
        "api_url": args.github_api_url,
        "user_token": args.github_token
    }

    github_api = github.Api(**api_args)
    local_workspace = workspace.Workspace(os.getcwd())

    sync_helper = sync.SyncHelper(github_api)
    sync_helper.sync_all(
        workspaces=local_workspace.organizations,
        github_organizations=github_api.organizations
    )


