!function(e){function t(s){if(i[s])return i[s].exports;var n=i[s]={exports:{},id:s,loaded:!1};return e[s].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var i={};return t.m=e,t.c=i,t.p="/assets/",t(0)}([function(e,t,i){"use strict";var s=i(9);window.addEventListener("DOMContentLoaded",s.init.bind(s)),window.generator=s},,,,,,,,,function(e,t,i){"use strict";var s=i(10),n=i(12),o=i(13),r=i(14),l=i(16),a=i(17),d=i(18),c={storageVersion:1,collection:null,smilepack:null,modified:!1,current_id:null,collectionData:null,smilepackData:null,usedSmiles:[],saveStatus:null,dropToSmilepackEvent:function(e){var t=this.smilepack.getSelectedCategory(0);if(null===t)return null;var i=parseInt(e.element.dataset.id);if(!(this.usedSmiles.indexOf(i)>=0)){this.collection.setSelected(i,!1);var s=this.collection.getSmileInfo(i);s.dragged=!0;var n=this.smilepack.addSmile(t,s);return null!=e.dropPosition&&this.smilepack.moveSmile(n,e.dropPosition),n===i?(this.usedSmiles.push(i),this.modified=!0,{name:"animateToSmile",id:n}):void 0}},dropToCollectionEvent:function(e){var t=parseInt(e.element.dataset.id),i=this.usedSmiles.indexOf(t);if(!(0>i)){this.smilepack.removeSmile(t),this.usedSmiles.splice(i,1);var s=this.collection.getSmileInfo(t,{withParent:!0});return this.modified=!0,s&&s.categoryId==this.collection.getSelectedCategory(2)?{name:"animateToSmile",id:t}:(s&&this.collection.setDragged(t,!1),{name:"fadeOut"})}},onchange:function(e,t){c.current_id=t,window.location.hash="#"+t.toString()},onaction:function(e){var t=e.action,i=e.categoryId;e.container===this.smilepack&&0==e.level&&("delete"==t&&null!=i?this.deleteSmilepackCategory(i,!0):"add"==t?o.open("category",{},this.modifySmilepackCategory.bind(this)):"edit"==t&&o.open("category",{edit:!0,category:this.smilepack.getCategoryInfo(0,e.categoryId)},this.modifySmilepackCategory.bind(this)))},onerror:function(e){console.log(e),alert(e.error||"Кажется, что-то пошло не так")},check_hash:function(){if(window.location.hash){var e=window.location.hash.substring(1);isNaN(e)||(e=parseInt(e),e!=c.current_id&&c.collection.set(2,e))}},toggleDark:function(){document.body.classList.toggle("dark"),window.localStorage.generatorDark=document.body.classList.contains("dark")?"1":"0"},importUserscript:function(e){if(!e.form||!e.form.file.value)return{error:"Выберите файл"};var t=e.onend;return n.import_userscript(e.form,function(e){this.importedUserscriptEvent(e,t)}.bind(this),function(e){console.log(e),t&&t({error:e.error||e})}),{success:!0}},importedUserscriptEvent:function(e,t){return!e.categories||e.categories.length<1?(console.log(e),void(t&&t({error:e.notice||"Кажется, что-то пошло не так"}))):(e.notice&&console.log(e.notice),this.replaceSmilepackData({categories:e.categories},e.ids),void(t&&t({success:!0,data:e,notice:e.notice})))},saveSmilepack:function(){var e=this.smilepack.getAllSmileIds();if(!e||e.length<1)return void alert("Добавьте хотя бы один смайлик!");for(var t=this.smilepack.getCategoriesWithHierarchy({"short":!0,withoutIds:!0,withoutIconUrl:!0}),i=[],s=[],n=0;n<e.length;n++){var r=this.smilepack.getSmileInfo(e[n],{withoutIds:!0,withParent:!0});e[n]>=0?(r.id=e[n],delete r.url,delete r.description):s.push(r),r.category_name=this.smilepack.getCategoryInfo(0,r.categoryId).name,delete r.categoryId,i.push(r)}o.open("smilepack",{mode:"saving"});var l=document.getElementById("lifetime");this.saveStatus={name:document.getElementById("name").value||void 0,lifetime:l?parseInt(l.value):0,categories:t,smiles:i,smilesToCreate:s,createPos:0},this._saveSmilepackProcessing()},_saveSmilepackProcessing:function(e){if(void 0!==e){var t=this.saveStatus.createPos;if(e.error||!e.smile)return this._saveSmilepackError(e);this.saveStatus.smilesToCreate[t].id=e.smile.id,delete this.saveStatus.smilesToCreate[t].url,this.saveStatus.createPos++}if(this.saveStatus.createPos<this.saveStatus.smilesToCreate.length){var t=this.saveStatus.createPos;return setTimeout(function(){n.create_smile({url:this.saveStatus.smilesToCreate[t].url,w:this.saveStatus.smilesToCreate[t].w,h:this.saveStatus.smilesToCreate[t].h},this._saveSmilepackProcessing.bind(this),this._saveSmilepackProcessingSmileError.bind(this))}.bind(this),350),void o.open("smilepack",{mode:"begin",current:this.saveStatus.createPos,count:this.saveStatus.smilesToCreate.length})}o.open("smilepack",{mode:"saving"}),n.create_smilepack(this.saveStatus.name,this.saveStatus.lifetime,this.saveStatus.categories,this.saveStatus.smiles,this.savedSmilepackEvent.bind(this),this._saveSmilepackError.bind(this))},_saveSmilepackProcessingSmileError:function(e){if(!e.error)return this._saveSmilepackError(e);var t=this.saveStatus.smilesToCreate[this.saveStatus.createPos],i="Не удалось создать смайлик "+t.url+":\n";return i+=e.error,i+="\nПропустить его и продолжить?",confirm(i)?(this.saveStatus.smiles.splice(this.saveStatus.smiles.indexOf(t),1),this.saveStatus.smilesToCreate.splice(this.saveStatus.createPos,1),this._saveSmilepackProcessing()):(this.saveStatus=null,void o.close("smilepack"))},_saveSmilepackError:function(e){this.onerror(e),this.saveStatus=null,o.close("smilepack")},savedSmilepackEvent:function(e){e.path&&window.history&&(document.title=document.getElementById("name").value,window.history.replaceState(null,null,e.path+location.hash));var t={mode:"saved",savedData:e};o.open("smilepack",t);var i=document.getElementById("smp-last-url");i.href=t.savedData.download_url,i.style.display="";var s=document.getElementById("smp-delete-container");t.savedData.fancy_deletion_date?(s.style.display="",document.getElementById("smp-delete-date").textContent=t.savedData.fancy_deletion_date):s.style.display="none",this.modified=!1},modifySmilepackCategory:function(e){if(!e.name)return{error:"Введите имя категории"};if(e.name.length>128)return{error:"Длинновато имя у категории!"};if(!e.iconId||!e.iconUrl)return{error:"Не выбрана иконка"};var t;return t=null==e.categoryId?this.smilepack.addCategory(0,0,{name:e.name,icon:{id:e.iconId,url:e.iconUrl}}):this.smilepack.editCategory(0,e.categoryId,{name:e.name,icon:{id:e.iconId,url:e.iconUrl}}),null==t?{error:"Кажется, что-то пошло не так"}:(null==e.categoryId&&this.smilepack.set(0,t),this.modified=!0,{success:!0,categoryId:t})},deleteSmilepackCategory:function(e,t){if(t&&!confirm("Удалить категорию «"+this.smilepack.getCategoryInfo(0,e).name+"»?"))return!1;for(var i=this.smilepack.removeCategory(0,e),s=0;i&&s<i.length;s++){c.collection.setDragged(i[s],!1);var n=this.usedSmiles.indexOf(i[s]);n>=0&&this.usedSmiles.splice(n,1)}return this.modified=!0,!0},moveAllSmiles:function(){var e=this.collection.getSelectedCategory(2);if(null==e)return!1;var t=this.smilepack.getSelectedCategory(0);if(null==t)return!1;var i=this.collection.getSmileIds(e);if(null==i)return!1;for(var s=0;s<i.length;s++)if(!(this.usedSmiles.indexOf(i[s])>=0)){var n=this.smilepack.addSmile(t,this.collection.getSmileInfo(i[s]));n==i[s]&&(this.usedSmiles.push(i[s]),this.collection.setDragged(i[s],!0),this.modified=!0)}return!0},addCustomSmile:function(e){if(!e.file&&(!e.url||e.url.length<9))return{error:"Надо бы смайлик"};if(e.url&&e.url.length>512)return{error:"Длинновата ссылка, перезалейте на что-нибудь поадекватнее"};if(isNaN(e.w)||e.w<1||isNaN(e.h)||e.h<1)return{error:"Размеры смайлика кривоваты"};var t=e.onend,i=c.smilepack.getSelectedCategory(0),s=function(s){this._addCustomSmileEvent(s,e,i,t)}.bind(this),o=function(e,i){this.onerror(e,i),t&&t({success:!1,error:e.error||e})}.bind(this);return e.url?n.create_smile({url:e.url,w:e.w,h:e.h},s,o):e.file&&n.upload_smile({file:e.file,w:e.w,h:e.h},s,o),{success:!0}},_addCustomSmileEvent:function(e,t,i,s){if(e.smile||(console.log(e),s&&s({error:e.error||e})),this.usedSmiles.indexOf(e.smile.id)>=0)return void(s&&s({error:"Этот смайлик уже используется!"}));var n=c.smilepack.addSmile(i,{id:e.smile.id,url:e.smile.url,description:e.smile.description,w:t.w,h:t.h});null!=n&&(this.usedSmiles.push(n),this.modified=!0,e.created||null==e.smile.category||this.collection.setDragged(e.smile.id,!0)),s&&s({success:!0,smileId:n})},storageSave:function(e){var t={storageVersion:this.storageVersion,ids:this.smilepack.getLastInternalIds()},i=this.smilepack.getAllSmileIds();if(!(i.length<1&&e)||confirm("Нет ни одного смайлика. Сохранить пустоту?")){for(var s=this.smilepack.getCategoriesWithHierarchy({"short":!0}),n={},o=0;o<s.length;o++)n[s[o].id]=s[o],s[o].smiles=[];for(var o=0;o<i.length;o++){var r=this.smilepack.getSmileInfo(i[o],{withParent:!0});n[r.categoryId].smiles.push(r),delete r.categoryId}t.categories=s,window.localStorage.smiles=JSON.stringify(t),this.modified=!1,e&&alert("Сохранено!")}},storageLoad:function(e){var t=window.localStorage.smiles;return!t||t.length<3?(e&&alert("Нечего загружать!"),!1):(t=JSON.parse(t),t.storageVersion!=this.storageVersion?(e&&alert("С момента сохранения база данных поменялась, не могу загрузить :("),!1):e&&this.modified&&!confirm("При загрузке потеряются несохранённые изменения, продолжить?")?!1:(this.replaceSmilepackData({categories:t.categories},t.ids),this.modified=!1,!0))},replaceSmilepackData:function(e,t){for(var i=this.smilepack.getCategoriesWithHierarchy({"short":!0,withoutIconUrl:!0}),s=0;s<i.length;s++)this.smilepack.removeCategory(0,i[s].id);for(var s=0;s<this.usedSmiles.length;s++)this.collection.setDragged(this.usedSmiles[s],!1);this.usedSmiles=[],this.smilepack.setLastInternalIds([0],0),this.smilepack.loadData(e);for(var s=0;s<e.categories.length;s++)for(var n=e.categories[s],o=0;o<n.smiles.length;o++){var r=n.smiles[o];this.smilepack.addSmile(n.id,r)}this.usedSmiles=this.smilepack.getAllSmileIds();for(var s=0;s<this.usedSmiles.length;s++)this.collection.setDragged(this.usedSmiles[s],!0);1==e.categories.length&&this.smilepack.set(0,e.categories[0].id),t&&this.smilepack.setLastInternalIds(t[0],t[1])},set_collection_smiles:function(e,t){n.get_smiles(t,function(i){for(var s=0;s<i.smiles.length;s++){var n=this.collection.addSmile(t,i.smiles[s]);null!==n&&this.usedSmiles.indexOf(i.smiles[s].id)>=0&&this.collection.setDragged(n,!0)}e.setSmiles(t,!0)}.bind(this))},initCollectionData:function(){this.collection.loadData(this.collectionData),1==this.collectionData.sections.length&&this.collection.set(0,this.collectionData.sections[0].id),this.check_hash()},initCollections:function(){this.collection=new s.Collection([["sections","section_id","Разделы:"],["subsections","subsection_id","Подразделы:"],["categories","category_id","Категории:"]],{title:"Коллекция смайликов",editable:!1,container:document.getElementById("collection"),get_smiles_func:this.set_collection_smiles.bind(this),onchange:this.onchange.bind(this),ondropto:this.dropToCollectionEvent.bind(this),message:"Выберите раздел для просмотра смайликов",additionalOnTop:!0,selectable:!1,selectableDragged:!1,useCategoryLinks:!0}),this.smilepack=new s.Collection([["categories","category_id","Категории:"]],{title:"Ваш смайлопак",editable:!0,container:document.getElementById("smilepack"),ondropto:this.dropToSmilepackEvent.bind(this),onaction:this.onaction.bind(this),message:this.smilepackData?"Выберите категорию смайлопака для просмотра":"Добавьте категорию здесь и заполните её перетаскиванием смайликов из коллекции",selectable:!1})},initData:function(){this.collectionData?this.initCollectionData():n.get_categories(function(e){this.collectionData=e,this.initCollectionData()}.bind(this)),this.smilepackData&&this.replaceSmilepackData(this.smilepackData)},bindButtonEvents:function(){var e=this.collection.getAdditionalContainer().querySelector(".action-move-all");e.addEventListener("click",this.moveAllSmiles.bind(this));var t=this.smilepack.getAdditionalContainer().querySelector(".action-add-smile");t.addEventListener("click",function(){o.open("smile",{},this.addCustomSmile.bind(this))}.bind(this)),document.querySelector(".action-save").addEventListener("click",this.saveSmilepack.bind(this)),document.getElementById("action-storage-save").addEventListener("click",function(){this.storageSave(!0)}.bind(this)),document.getElementById("action-storage-load").addEventListener("click",function(){this.storageLoad(!0)}.bind(this));var i=document.getElementById("action-import-userscript");i.addEventListener("click",function(){o.open("import_userscript",{},this.importUserscript.bind(this))}.bind(this)),document.getElementById("action-toggle-dark").addEventListener("click",this.toggleDark.bind(this))},registerDialogs:function(){o.init(document.getElementById("dialog-background"),{category:new r,smile:new l,import_userscript:new a,smilepack:new d})},init:function(){this.initCollections(),this.initData(),this.bindButtonEvents(),this.registerDialogs(),"1"==window.localStorage.generatorDark&&this.toggleDark(),window.addEventListener("hashchange",this.check_hash),window.addEventListener("beforeunload",function(e){if(this.modified){var t="Есть несохранённые изменения в смайлопаке.";return e&&(e.returnValue=t),t}}.bind(this))}};e.exports=c},function(e,t,i){"use strict";var s=i(11),n={};n.Collection=function(e,t){this.hierarchy=e,this._depth=e.length,this.options=t,this._categories=[],this._rootChildren=[],this._lastIds=[],this._smiles={},this._selectedSmileIds=[],this._lastSelectedSmileId=null,this._smileMovePosId=null,this._lastSmileId=0,this._lazyCategoriesQueue=[],this._lazyProcessing=0,t.lazyStep?this._lazyStep=t.lazyStep:navigator.userAgent.toLowerCase().indexOf("chrome")>=0?this._lazyStep=15:this._lazyStep=3,this._lazyCallback=this._lazyLoaded.bind(this),this._selectedIds=[],this._dom={},this._dom.container=t.container||document.createElement("div"),t.className&&!this._dom.container.classList.contains(t.className)&&this._dom.container.classList.add(t.className),this._dom.container.getElementsByClassName("additional")[0]&&(this._dom.additionalContainer=this._dom.container.getElementsByClassName("additional")[0],this._dom.container.removeChild(this._dom.additionalContainer),this._dom.additionalContainer.style.display="none"),this._dom.container.innerHTML="",this._dom.container.addEventListener("click",this._onclick.bind(this)),this._dom.tabs_container=document.createElement("div"),this._dom.tabs_container.className="tabs-wrapper",this._dom.container.appendChild(this._dom.tabs_container),this._dom.tabs_containers=[],t.title?(this._dom.title=document.createElement("div"),this._dom.title.className="collection-title",this._dom.title.textContent=t.title,this._dom.tabs_container.appendChild(this._dom.title)):this._dom.title=null,this._dom.smiles_current_id=null,this._dom.category_description=document.createElement("div"),this._dom.category_description.className="category-description",this._dom.category_description.textContent=t.message||"",this._dom.container.appendChild(this._dom.category_description),this._dom.additionalContainer||(this._dom.additionalContainer=document.createElement("div"),this._dom.additionalContainer.className="additional",this._dom.additionalContainer.style.display="none"),this._dom.container.appendChild(this._dom.additionalContainer),this._dom.dropHint=document.createElement("div"),this._dom.dropHint.className="drop-hint",this._dom.dropHint.style.display="none",this._dom.container.appendChild(this._dom.dropHint);for(var i=0;i<this._depth;i++){this._categories.push({}),this._lastIds.push(0),this._selectedIds.push(null);var n=document.createElement("div");if(n.className="tabs-level",n.dataset.level=i.toString(),i>0&&(n.style.display="none"),this.hierarchy[i][2]&&n.appendChild(document.createTextNode(this.hierarchy[i][2])),t.editable){var o=document.createElement("a");o.className="action-btn action-add",o.dataset.action="add",o.dataset.level=i.toString(),o.href="#",n.appendChild(o)}this._dom.tabs_containers.push(n),this._dom.tabs_container.appendChild(n)}this._dom.rootCategories=this._buildDomTabs(0,0),this._dom.rootCategories.style.display="",s.add(this._dom.container,{onstart:this._dragStart.bind(this),onmove:this._dragMove.bind(this),onmoveto:this._dragMoveTo.bind(this),ondropto:this._dragDropTo.bind(this),ontransitionend:this._dragEnd.bind(this),onclick:this._smileClickEvent.bind(this)})},n.Collection.prototype.getDOM=function(){return this._dom.container},n.Collection.prototype.getAdditionalContainer=function(){return this._dom.additionalContainer},n.Collection.prototype.loadData=function(e){this._loadDataLevel(e[this.hierarchy[0][0]],0,0)},n.Collection.prototype.addCategory=function(e,t,i){var s=e-1,n=e>0?this._categories[s][t]:null;if(e>0&&!n)return null;var o=i.id;return null==o&&(this._lastIds[e]--,o=this._lastIds[e]),this._categories[e][o]={id:o,parentId:e>0?t:null,level:e,name:i.name,description:i.description,dom:null,iconId:i.icon?i.icon.id:-1,iconUrl:i.icon?i.icon.url:null,smileIds:null,childrenIds:e+1<this._depth?[]:null,childrenDom:null,smilesDom:null,lazyQueue:[]},this._buildCategoryDom(e,o,!0),o},n.Collection.prototype._buildCategoryDom=function(e,t,i){var s=this._categories[e][t],n=document.createElement("a");if(n.className="tab-btn",n.dataset.id=t.toString(),n.dataset.level=e.toString(),n.href=!this.options.useCategoryLinks||e<this._depth-1?"#":"#"+t,n.title=s.description||"",s.iconUrl){var o=document.createElement("img");o.src=s.iconUrl,o.className="tab-icon",o.dataset.id=s.iconId,n.appendChild(o)}if(n.appendChild(document.createTextNode(s.name)),this.options.editable){var r=document.createElement("span");r.className="actions";var l=document.createElement("a");l.className="action-btn action-edit",l.dataset.action="edit",r.appendChild(l);var a=document.createElement("a");a.className="action-btn action-delete",a.dataset.action="delete",r.appendChild(a),n.appendChild(r)}if(i){if(e>0){var d=this._categories[e-1][s.parentId];d.childrenDom||(d.childrenDom=this._buildDomTabs(e,s.parentId)),d.childrenIds.push(t),d.childrenDom.appendChild(n)}else this._rootChildren.push(t),this._dom.rootCategories.appendChild(n);s.dom=n}return n},n.Collection.prototype.editCategory=function(e,t,i){if(0>e||e>=this._depth||!this._categories[e][t])return null;var s=this._categories[e][t];s.name=i.name,s.description=i.description,s.iconId=i.icon?i.icon.id:-1,s.iconUrl=i.icon?i.icon.url:null;var n=this._buildCategoryDom(e,t,!1);this._selectedIds[e]==t&&n.classList.add("tab-btn-active");var o=s.dom.parentNode;return o.insertBefore(n,s.dom),o.removeChild(s.dom),s.dom=n,t},n.Collection.prototype.removeCategory=function(e,t){if(0>e||e>=this._depth)return null;var i=this._categories[e][t];if(!i)return null;var s=[];if(this._selectedIds[e]==t&&this.set(e,null),e+1>=this._depth)this._dom.smiles_current_id==t&&this.setSmiles(null);else for(;i.childrenIds.length>0;)Array.prototype.push.apply(s,this.removeCategory(e+1,i.childrenIds[0]));i.smilesDom&&i.smilesDom.parentNode.removeChild(i.smilesDom);for(var n=0;i.smileIds&&n<i.smileIds.length;n++)delete this._smiles[i.smileIds[n]],s.push(i.smileIds[n]);if(i.dom.parentNode&&i.dom.parentNode.removeChild(i.dom),i.childrenDom&&i.childrenDom.parentNode&&i.childrenDom.parentNode.removeChild(i.childrenDom),delete this._categories[e][t],e>0){var o=this._categories[e-1][i.parentId].childrenIds.indexOf(t);o>-1&&this._categories[e-1][i.parentId].childrenIds.splice(o,1)}else{var o=this._rootChildren.indexOf(t);o>-1&&this._rootChildren.splice(o,1)}return s},n.Collection.prototype.addSmile=function(e,t){if(!t)return null;var i=this._categories[this._depth-1][e];if(!i)return null;var s=t.id;return(null==s||isNaN(s))&&(this._lastSmileId--,s=this._lastSmileId),this._smiles[s]={id:s,categoryId:e,url:t.url,description:t.description,tags:t.tags,width:t.w,height:t.h,dom:null,dragged:t.dragged||!1,selected:t.selected||!1},null===i.smileIds&&(i.smileIds=[]),i.smileIds.push(s),i.smilesDom&&this._addSmileDom(s),this._smiles[s].selected&&this._selectedSmileIds.push(s),s},n.Collection.prototype._addSmileDom=function(e){var t=this._smiles[e],i=this._categories[this._depth-1][t.categoryId];if(t.dom||i.smileIds.indexOf(t.id)<0)return!1;var s=document.createElement("img");return s.alt="",s.title=(t.tags||[]).join(", ")||t.description||t.url,s.width=t.width,s.height=t.height,s.classList.add("smile"),s.classList.add("smile-loading"),s.dataset.id=t.id.toString(),t.dragged&&s.classList.add("dragged"),t.selected&&s.classList.add("selected"),s.src="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",s.dataset.src=t.url,i.lazyQueue.push(e),i.smilesDom.appendChild(s),t.dom=s,this._lazyProcessing<this._lazyStep&&this._lazyNext(),!0},n.Collection.prototype.removeSmile=function(e){var t=this._smiles[e];if(!t)return!1;var i=this._categories[this._depth-1][t.categoryId];i.smilesDom.removeChild(t.dom);var s=i.smileIds.indexOf(e);return s>=0&&i.smileIds.splice(s,1),s=this._selectedSmileIds.indexOf(e),s>=0&&this._selectedSmileIds.splice(s,1),delete this._smiles[e],!0},n.Collection.prototype.moveSmile=function(e,t){if(e==t)return!1;var i=this._smiles[e],s=null!=t?this._smiles[t]:null;if(!i||null!=t&&!s)return!1;if(s&&s.categoryId!=i.categoryId)return!1;var n=this._categories[this._depth-1][i.categoryId],o=n.smileIds.indexOf(i.id);return o>=0&&n.smileIds.splice(o,1),s?(i.dom.parentNode.insertBefore(i.dom,s.dom),o=n.smileIds.indexOf(s.id),n.smileIds.splice(o,0,i.id)):(i.dom.parentNode.appendChild(i.dom),n.smileIds.push(i.id)),!0},n.Collection.prototype.set=function(e,t){if(0>e||e>=this._depth)return!1;var i=this._categories[e][t];if(null!==t&&!i)return!1;if(this._selectedIds[e]==t)return!0;if(i&&e>0&&this.set(e-1,i.parentId),null!==this._selectedIds[e])for(var s=e;s<this._depth&&null!==this._selectedIds[s];s++)this._categories[s][this._selectedIds[s]].dom.classList.remove("tab-btn-active"),s+1<this._depth&&(this._categories[s][this._selectedIds[s]].childrenDom.style.display="none",this._dom.tabs_containers[s+1].style.display="none"),this._selectedIds[s]=null;return i?(i.dom.classList.add("tab-btn-active"),this._selectedIds[e]=t,e+1<this._depth?(this._dom.tabs_containers[e+1].style.display="",i.childrenDom.style.display=""):this.setSmiles(t),!0):!0},n.Collection.prototype.setSmiles=function(e,t){if(null===e)return null!==this._dom.smiles_current_id&&(this._categories[this._depth-1][this._dom.smiles_current_id].smilesDom.style.display="none",this._dom.smiles_current_id=null,this._dom.category_description.textContent="",this._dom.additionalContainer.style.display="none"),!0;var i=null;null!==this._dom.smiles_current_id&&(i=this._categories[this._depth-1][this._dom.smiles_current_id].smilesDom);var s=this._categories[this._depth-1][e];if(!s)return!1;if(this._dom.category_description.textContent=s.description||"",null===s.smileIds&&(t||!this.options.get_smiles_func?s.smileIds=[]:(i&&i.classList.add("processing"),this.options.get_smiles_func(this,e))),null!==s.smileIds&&e!==this._dom.smiles_current_id){if(!s.smilesDom){var n=document.createElement("div");n.className="smiles-list",n.style.display="none",this.options.additionalOnTop?this._dom.container.appendChild(n):this._dom.container.insertBefore(n,this._dom.additionalContainer),s.smilesDom=n,s.lazyQueue=[];for(var o=0;o<s.smileIds.length;o++)this._addSmileDom(s.smileIds[o]);s.lazyQueue.length>0&&this._lazyCategoriesQueue.push(e)}this.deselectAll(),i&&(i.classList.contains("processing")&&i.classList.remove("processing"),i.style.display="none"),i=s.smilesDom,this._dom.smiles_current_id=e,i.style.display="",this.options.onchange&&this.options.onchange(this,e),this._dom.additionalContainer.style.display=""}return!0},n.Collection.prototype.getDragged=function(e){var t=this._smiles[e];return t?t.dragged:null},n.Collection.prototype.setDragged=function(e,t){var i=this._smiles[e];return i?(i.dragged!=t&&(i.dragged=!i.dragged,i.dom&&i.dom.classList.toggle("dragged")),!0):!1},n.Collection.prototype.getSelected=function(e){var t=this._smiles[e];return t?t.selected:null},n.Collection.prototype.setSelected=function(e,t){var i=this._smiles[e];if(!i||t&&i.categoryId!=this._selectedIds[this._depth-1])return!1;if(t&&i.dragged&&!options.selectableDragged)return!1;i.selected!=t&&(i.selected=!i.selected,i.dom&&i.dom.classList.toggle("selected"));var s=this._selectedSmileIds.indexOf(i.id);return t&&0>s?this._selectedSmileIds.push(i.id):!t&&s>=0&&this._selectedSmileIds.splice(s,1),t?this._lastSelectedSmileId=i.id:0==this._selectedSmileIds.length&&(this._lastSelectedSmileId=null),!0},n.Collection.prototype.toggleSelected=function(e){var t=this._smiles[e];return t?this.setSelected(t.id,!t.selected):!1},n.Collection.prototype.deselectAll=function(){var e;if(0==this._selectedSmileIds.length)return!1;for(var t=0;t<this._selectedSmileIds.length;t++)e=this._smiles[this._selectedSmileIds[t]],e.selected=!1,e.dom&&e.dom.classList.toggle("selected");return this._selectedSmileIds=[],this._lastSelectedSmileId=null,!0},n.Collection.prototype.getDropPosition=function(){return this._smileMovePosId},n.Collection.prototype.getLastInternalIds=function(){return[this._lastIds,this._lastSmileId]},n.Collection.prototype.setLastInternalIds=function(e,t){for(var i=0;i<this._depth;i++)this._lastIds[i]=parseInt(e[i]);this._lastSmileId=parseInt(t)},n.Collection.prototype.getCategoryInfo=function(e,t,i){if(0>e||e>=this._depth)return null;var s=this._categories[e][t];if(!s)return null;var n={name:s.name,description:s.description,icon:s.iconUrl?{id:null!=s.iconId?parseInt(s.iconId):null,url:i&&i.withoutIconUrl?void 0:s.iconUrl}:null};return i&&i["short"]||(n.level=s.level),i&&i.withoutIds||(n.id=s.id),n},n.Collection.prototype.getCategoriesWithHierarchy=function(e){var t,i,s,n=[],o=[];for(t=0;t<this._depth;t++){o.push({});for(s in this._categories[t])i=this.getCategoryInfo(t,s,e),t+1<this._depth&&(i[this.hierarchy[t+1][0]]=[]),t>0?o[t-1][this._categories[t][s].parentId][this.hierarchy[t][0]].push(i):n.push(i),o[t][i.id]=i}return n},n.Collection.prototype.getSmileInfo=function(e,t){var i=this._smiles[e];if(!i)return null;var s={url:i.url,w:i.width,h:i.height,description:i.description};return t&&t.withoutIds||(s.id=i.id),t&&t.withParent&&(s.categoryId=i.categoryId),s},n.Collection.prototype.getSmileIdByDom=function(e){if(!e||!this._dom.container.contains(e)||!e.classList.contains("smile"))return null;var t=this._smiles[parseInt(e.dataset.id)];return t?t.id:null},n.Collection.prototype.getSmileIds=function(e){return this._categories[this._depth-1][e]?Array.prototype.slice.apply(this._categories[this._depth-1][e].smileIds):null},n.Collection.prototype.getAllCategorizedSmileIds=function(){var e={};for(var t in this._categories[this._depth-1])e[t]=Array.prototype.slice.apply(this._categories[this._depth-1][t].smileIds);return e},n.Collection.prototype.getAllSmileIds=function(){var e=[];for(var t in this._categories[this._depth-1])e.push.apply(e,this._categories[this._depth-1][t].smileIds);return e},n.Collection.prototype.getSelectedCategory=function(e){return this._selectedIds[e]},n.Collection.prototype.getParentId=function(e,t){return 0>=e||e>=this._depth||!this._categories[e][t]?null:this._categories[e][t].parentId},n.Collection.prototype.typeOfElement=function(e){if(!e)return null;if(e.classList.contains("smile")&&this._smiles[parseInt(e.dataset.id)].dom===e){var t=parseInt(e.dataset.id);return{type:"smile",id:t,categoryId:this._smiles[t].categoryId}}return null},n.Collection.prototype._loadDataLevel=function(e,t,i){for(var s,n=0;n<e.length;n++)s=this.addCategory(t,i,e[n]),t+1<this._depth&&e[n][this.hierarchy[t+1][0]]&&this._loadDataLevel(e[n][this.hierarchy[t+1][0]],t+1,s)},n.Collection.prototype._buildDomTabs=function(e,t){var i=e-1;if(e>0&&!this._categories[i][t])return null;var s=document.createElement("div");return s.className="tabs-items",s.style.display="none",e>0&&(s.dataset.id="tabs-"+t.toString()),this.options.editable?this._dom.tabs_containers[e].insertBefore(s,this._dom.tabs_containers[e].lastElementChild):this._dom.tabs_containers[e].appendChild(s),s},n.Collection.prototype._onclick=function(e){if(!e.target.classList.contains("smile")){for(var t=null,i=null,s=null;!i||!s;){if(t=t?t.parentNode:e.target,!t||t===this._dom.container||t===document.body){if(i||s)break;return}t.classList.contains("action-btn")?(i=t,l=i.dataset.action):t.classList.contains("tab-btn")&&(s=t)}var n=s&&s.dataset.id?parseInt(s.dataset.id):null,o=null!==n?parseInt(s.dataset.level):null,r=null!==o?this._categories[o][n]:null,l=i?i.dataset.action:null;if(l)return this.options.onaction&&this.options.onaction({container:this,action:l,level:r?r.level:parseInt(i.dataset.level),categoryId:n}),e.preventDefault(),!1;if(null!==o){if(!this.set(o,n))return;return e.preventDefault(),!1}}},n.Collection.prototype._smileClickEvent=function(e){if(e.element.classList.contains("smile")&&e.element.dataset.id){var t=this._smiles[parseInt(e.element.dataset.id)];if(t&&this.options.selectable){var i=this._categories[this._depth-1][t.categoryId];if(e.event.shiftKey&&null!=this._lastSelectedSmileId){var s=i.smileIds.indexOf(this._lastSelectedSmileId),n=i.smileIds.indexOf(t.id);if(s>n){var o=n;n=s,s=o}for(var r=s;n>=r;r++)this.setSelected(i.smileIds[r],!0)}else e.event.ctrlKey||e.event.metaKey||!(this._selectedSmileIds.length>1)&&t.selected?this.setSelected(t.id,!t.selected):(this.deselectAll(),this.setSelected(t.id,!0))}}},n.Collection.prototype._dragStart=function(e){var t=e.element;if(t===this._dom.container)return null;do{if(t.dataset.action)break;if(t.classList.contains("smile")&&!t.classList.contains("dragged")){var i=this._smiles[parseInt(t.dataset.id)];return!i||i.dragged?null:t}if(this.options.editable&&t.classList.contains("tab-btn")){var s=parseInt(t.dataset.level),n=parseInt(t.dataset.id);if(this._categories[s]&&this._categories[s][n])return t}t=t.parentNode}while(t&&t!==this._dom.container);return null},n.Collection.prototype._dragMove=function(e){e.targetContainer!==this._dom.container&&(this._dom.dropHint.style.display="none");var t=e.element;t.classList.contains("smile")?(e.starting&&!t.classList.contains("dragged")&&this.setDragged(parseInt(t.dataset.id),!0),e.starting&&e.overlay&&e.overlay.dataset.src&&(e.overlay.src=e.overlay.dataset.src,delete e.overlay.dataset.src,e.overlay.classList.remove("smile-loading"))):t.classList.contains("tab-btn")&&e.starting&&!t.classList.contains("dragged")&&t.classList.add("dragged")},n.Collection.prototype._dragMoveTo=function(e){var t=e.element;if(t.classList.contains("smile")){var i=parseInt(t.dataset.id);if(this.options.editable){var s=this.getSmileIdByDom(e.mouseOver);this._calculateSmileMove(e.x,e.y,i,s)}}else t.classList.contains("tab-btn")},n.Collection.prototype._dragDropTo=function(e){var t=this._smileMovePosId;if(this._smileMovePosId=null,this._dom.dropHint.style.display="none",!this.options.ondropto)return null;if(e.sourceContainer===this._dom.container&&this.options.editable){if(!e.element.classList.contains("smile"))return null;var i=this._smiles[e.element.dataset.id];if(!i)return null;var s=this._categories[this._depth-1][i.categoryId];if(null==t){var n=this._smiles[s.smileIds[s.smileIds.length-1]],o=n.dom.getBoundingClientRect();(e.y>=o.bottom||e.y>=o.top&&e.x>=o.left)&&this.moveSmile(i.id,null)}else this.moveSmile(i.id,t);return null}var r=this.options.ondropto({sourceContainerElement:e.sourceContainer,targetContainer:this,element:e.element,overlay:e.overlay,dropPosition:t});return r&&"animateToSmile"==r.name?{name:"animate",targetElement:this._smiles[r.id].dom}:r},n.Collection.prototype._dragEnd=function(e){if(!e.element)return null;var t=e.element;t.classList.contains("smile")?t.classList.contains("dragged")&&this.setDragged(parseInt(t.dataset.id),!1):t.classList.contains("tab-btn")&&t.classList.contains("dragged")&&t.classList.remove("dragged")},n.Collection.prototype._calculateSmileMove=function(e,t,i,s){this._smileMovePosId;if(i==s&&(s=null),null==s)return this._dom.dropHint.style.display="none",void(this._smileMovePosId=null);var n,o=this._smiles[s],r=this._categories[this._depth-1][o.categoryId],l=o.dom.getBoundingClientRect(),a=(e-l.left)/l.width;if(a>=.5){var n=r.smileIds.indexOf(o.id)+1;n=n>=r.smileIds.length?null:r.smileIds[n]}else n=s;if(n!=this._smileMovePosId){this._smileMovePosId=n;var d=null;
n==s?(d=r.smileIds.indexOf(s)-1,d=d>=0?this._smiles[r.smileIds[d]]:null):null!=n&&(d=this._smiles[n]);var c=d?d.dom.getBoundingClientRect():null;c&&c.height<l.height?this._dom.dropHint.style.height=c.height+"px":this._dom.dropHint.style.height=l.height+"px",null!=n?o.dom.parentNode.insertBefore(this._dom.dropHint,this._smiles[n].dom):o.dom.parentNode.appendChild(this._dom.dropHint),this._dom.dropHint.style.display=""}},n.Collection.prototype._lazyNext=function(){var e=this._selectedIds[this._depth-1];if(null!==e||0!=this._lazyCategoriesQueue.length){null===e&&(e=this._lazyCategoriesQueue[0]);for(var t=this._categories[this._depth-1][e];0==t.lazyQueue.length;){var i=this._lazyCategoriesQueue.indexOf(e);if(i>=0&&this._lazyCategoriesQueue.splice(i,1),0==this._lazyCategoriesQueue.length)return;e=this._lazyCategoriesQueue[0],t=this._categories[this._depth-1][e]}var s=t.lazyQueue.splice(0,1)[0],n=this._smiles[s].dom;n.addEventListener("load",this._lazyCallback),n.addEventListener("error",this._lazyCallback),this._lazyProcessing++,n.src=n.dataset.src,delete n.dataset.src}},n.Collection.prototype._lazyLoaded=function(e){e.target.classList.remove("smile-loading"),this._lazyProcessing--,e.target.removeEventListener("load",this._lazyCallback),e.target.removeEventListener("error",this._lazyCallback),this._lazyProcessing<this._lazyStep&&setTimeout(this._lazyNext.bind(this),0)},e.exports=n},function(e,t){"use strict";var i={transitionDuration:175,startMargin:4,_containers:[],_currentContainer:null,_currentElement:null,_overlay:null,_startPos:null,_startElementPos:null,_mouseOver:null,_started:!1,_callbacks:null,add:function(e,t){t.dom=e,this._containers.push(t);var i=function(e){return this._eventDown(e,t)}.bind(this);t._mousedown=i,e.addEventListener("mousedown",i)},_findContainer:function(e){if(!e)return null;for(var t=null,i=0;i<this._containers.length;i++)if(this._containers[i].dom.contains(e)){t=this._containers[i];break}return t},_buildOverlay:function(e,t){var i=e.cloneNode(!0);return t=t||e.getBoundingClientRect(),i.addEventListener("click",this._eventPrevent),i.addEventListener("mousedown",this._eventPrevent),i.addEventListener("mouseup",this._eventPrevent),i.classList.add("overlay"),i.style.margin="0",i.style.position="fixed",i.style.width=t.width+"px",i.style.height=t.height+"px",i.style.boxSizing="border-box",i.style.pointerEvents="none",i.title="",i},_eventPrevent:function(e){return e.preventDefault(),e.stopPropagation(),!1},_eventDown:function(e,t){if(!this._currentElement&&1==(e.which||e.button)){var i=e.target||e.srcElement;if(i=t.onstart({element:i,x:e.clientX,y:e.clientY}))return this._stop(),this._currentElement=i,this._currentContainer=t,this._startPos=[e.clientX,e.clientY],this._started=!1,this._callbacks=[function(e){return this._eventMove(e)}.bind(this),function(e){return this._eventUp(e)}.bind(this)],document.body.addEventListener("mousemove",this._callbacks[0]),document.body.addEventListener("mouseup",this._callbacks[1]),e.preventDefault(),!1}},_eventMove:function(e){if(this._currentElement&&this._currentContainer){e.preventDefault();var t=e.clientX-this._startPos[0],i=e.clientY-this._startPos[1],s=!this._started;if(s){if(t>-this.startMargin&&t<this.startMargin&&i>-this.startMargin&&i<this.startMargin)return!1;var n=this._currentElement.getBoundingClientRect();this._startElementPos=[n.left,n.top],this._overlay=this._buildOverlay(this._currentElement,n),document.body.appendChild(this._overlay),document.body.classList.contains("drag-enabled")||document.body.classList.add("drag-enabled"),this._currentElement.addEventListener("click",this._eventPrevent),this._started=!0}var o=this._startElementPos[0]+t,r=this._startElementPos[1]+i;this._overlay.style.left=o+"px",this._overlay.style.top=r+"px";var l=this._mouseOver;this._mouseOver=document.elementFromPoint(e.clientX,e.clientY);var a=this._mouseOver?this._findContainer(this._mouseOver):null;return this._currentContainer.onmove&&this._currentContainer.onmove({targetContainer:a?a.dom:null,element:this._currentElement,x:e.clientX,y:e.clientY,mouseOver:this._mouseOver,oldMouseOver:l,starting:s,overlay:this._overlay}),a&&a.onmoveto&&a.onmoveto({sourceContainer:this._currentContainer.dom,element:this._currentElement,x:e.clientX,y:e.clientY,mouseOver:this._mouseOver,overlay:this._overlay}),!1}},_eventUp:function(e){if(this._currentElement&&this._currentContainer){if(!this._started)return this._currentContainer.onclick&&this._currentContainer.onclick({element:this._currentElement,event:e}),void this._stop();e.preventDefault();var t=null,i=null,s=!1;this._mouseOver&&(t=this._findContainer(this._mouseOver),t&&t.ondropto&&(i=t.ondropto({sourceContainer:this._currentContainer.dom,element:this._currentElement,overlay:this._overlay,x:e.clientX,y:e.clientY}))),i?s=!0:i={name:"animate",targetElement:this._currentElement},this._currentContainer.ondrop&&this._currentContainer.ondrop({targetContainer:s?t.dom:null,targetElement:i.element,element:this._currentElement,overlat:this._overlay,x:e.clientX,y:e.clientY,mouseOver:this._mouseOver}),this._stop(i,(s?t:this._currentContainer).ontransitionend)}},_stop:function(e,t){this._currentElement&&this._currentElement.removeEventListener("click",this._eventPrevent),e&&"animate"==e.name&&e.targetElement?this._animate(e.targetElement,t):e&&"fadeOut"==e.name?this._animateFadeOut():e&&"nothing"==e.name||(this._overlay&&(this._overlay.parentNode||this._overlay.parentElement).removeChild(this._overlay),t&&t({element:e?e.targetElement:null})),this._currentElement=null,this._currentContainer=null,this._startPos=null,this._startElementPos=null,this._overlay=null,this._started=!1,this._mouseOver=null,document.body.classList.contains("drag-enabled")&&document.body.classList.remove("drag-enabled"),this._callbacks&&(document.body.removeEventListener("mousemove",this._callbacks[0]),document.body.removeEventListener("mouseup",this._callbacks[1]),this._callbacks=null)},_animate:function(e,t){var i=(this._currentElement,this._overlay),s=e.getBoundingClientRect(),n=s.left,o=s.top;s=null;var r=function(s){if(!s||"top"==s.propertyName||"left"==s.propertyName){var n=i.parentNode||i.parentElement;n&&(n.removeChild(i),t&&t({element:e}))}}.bind(this);i.classList.add("stopping"),i.style.transitionDuration=this.transitionDuration+"ms",i.style.left=n+"px",i.style.top=o+"px",setTimeout(r,this.transitionDuration)},_animateFadeOut:function(){var e=this._overlay;e.style.transitionProperty="opacity",e.style.transitionDuration=this.transitionDuration+"ms",e.style.opacity="0.0",setTimeout(function(){e.parentNode.removeChild(e)},this.transitionDuration)}};e.exports=i},function(e,t){"use strict";var i={getXmlHttp:function(){if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;var e;try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){e=null}}return e},request:function(e){var t=this.getXmlHttp();t.open(e.method||"GET",e.url);for(var i in e.headers||{})t.setRequestHeader(i,e.headers[i]);return t.onreadystatechange=function(){var i,s=!1;if(4==t.readyState){if(t.status>=400){if(s=!0,e.onerror){if(i=t.responseText,"json"==e.format&&i.length>1&&"{"==i[0])try{i=JSON.parse(t.responseText)}catch(n){}e.onerror(i,t)}}else i="json"==e.format?JSON.parse(t.responseText):t.responseText,e.onload&&e.onload(i,t);e.onend&&e.onend(s,i,t)}},t.send(e.data||null),t},get_categories:function(e,t,i){return this.request({url:"/smiles/",format:"json",onload:e,onerror:t,onend:i})},get_smiles:function(e,t,i,s){return this.request({url:"/smiles/"+parseInt(e).toString(),format:"json",onload:t,onerror:i,onend:s})},create_smilepack:function(e,t,i,s,n,o,r){return this.request({method:"POST",url:"/smilepack/",format:"json",onload:n,onerror:o,onend:r,data:JSON.stringify({name:e,lifetime:t,categories:i,smiles:s}),headers:{"Content-Type":"application/json"}})},import_userscript:function(e,t,i,s){return this.request({method:"POST",url:"/smilepack/import",format:"json",onload:t,onerror:i,onend:s,data:new FormData(e)})},create_smile:function(e,t,i,s){return this.request({method:"POST",url:"/smiles/",format:"json",onload:t,onerror:i,onend:s,data:JSON.stringify(e),headers:{"Content-Type":"application/json"}})},upload_smile:function(e,t,i,s){var n=new FormData;for(var o in e)n.append(o,e[o]);return this.request({method:"POST",url:"/smiles/",format:"json",onload:t,onerror:i,onend:s,data:n})}};e.exports=i},function(e,t){"use strict";var i={dialogs:{},opened:[],background:null};i.init=function(e,t){this.background=e;for(var i in t)this.register(i,t[i])},i.register=function(e,t){if(this.dialogs[e])throw new Error("Conflict dialog "+e);this.dialogs[e]={dialog:t,submitCallback:null},t.setOpenEvent(function(t){this._openEvent(e,t)}.bind(this)),t.setSubmitEvent(function(t){return this._submitEvent(e,t)}.bind(this))},i.open=function(e,t,i){if(!this.dialogs[e])throw new Error("Unknown dialog "+e);this.dialogs[e].dialog.open(t),this.dialogs[e].submitCallback=i},i.close=function(e){if(!this.dialogs[e])throw new Error("Unknown dialog "+e);return!this.opened.indexOf(e)<0?null:void this.dialogs[e].dialog.close()},i._openEvent=function(e,t){var i=this.dialogs[e],s=this.opened.indexOf(e);s>=0!=t&&(t?(this.opened.length>0&&this.dialogs[this.opened.length-1].hide(),this.opened.push(e)):(this.opened.splice(s,1),i.submitCallback=null,this.opened.length>0&&this.dialogs[this.opened.length-1].show()),this.background&&(this.opened.length>0?this.background.classList.remove("hidden"):this.background.classList.add("hidden")))},i._submitEvent=function(e,t){var i=this.dialogs[e].submitCallback;return i?i(t):{success:!0}},e.exports=i},function(e,t,i){"use strict";var s=i(15),n=function(e){s.apply(this,[e||document.getElementById("dialog-new-category")]),this.form=this.dom.querySelector("form"),this._bindEvents()};n.prototype=Object.create(s.prototype),n.prototype.constructor=n,n.prototype.onsubmit=function(){var e,t,i=this.form;if(i.icon.length)for(var s=0;s<i.icon.length&&(!i.icon[s].checked&&0!=s||(e=i.icon[s].value,t=i.icon[s].dataset.valueUrl,!i.icon[s].checked));s++);else e=i.icon.value,t=i.icon.dataset.valueUrl;var n={success:!0};return this._submitEvent&&(n=this._submitEvent({categoryId:i.category.value.length>0?parseInt(i.category.value):null,name:i.name.value,iconId:e,iconUrl:t})),n.success?void this.close():this.error(n.error)},n.prototype.open=function(e){e.edit!=this.dom.classList.contains("mode-edit")&&(this.dom.classList.toggle("mode-add"),this.dom.classList.toggle("mode-edit")),e.edit?(this.form.name.value=e.category.name,this.form.icon.value=e.category.icon.id,this.form.category.value=e.category.id):(this.form.name.value="",this.form.icon[0]&&(this.form.icon.value=this.form.icon[0].value),this.form.category.value=""),s.prototype.open.apply(this,arguments)},e.exports=n},function(e,t){"use strict";var i=function(e){if(!e)throw new Error("Dialog requires element");this.dom=e,this.form=null,this._openEvent=null,this._submitEvent=null};i.prototype.getDOM=function(){return this.dom},i.prototype._bindEvents=function(){if(this.form){var e=function(e){return this.onsubmit(e),e.preventDefault(),!1}.bind(this);this.form.addEventListener("submit",e)}var t=this.dom.querySelectorAll(".dialog-close");if(t.length>0)for(var i=function(e){return this.close(),e.preventDefault(),!1}.bind(this),s=0;s<t.length;s++)t[s].addEventListener("click",i)},i.prototype.setOpenEvent=function(e){this._openEvent=e},i.prototype.setSubmitEvent=function(e){this._submitEvent=e},i.prototype.open=function(e){this.show(),this._openEvent&&this._openEvent(!0)},i.prototype.close=function(){this.hide(),this._openEvent&&this._openEvent(!1)},i.prototype.show=function(e){this.dom.classList.remove("hidden")},i.prototype.hide=function(){this.dom.classList.add("hidden")},i.prototype.error=function(e){alert(e)},i.prototype.onsubmit=function(e){var t={success:!0};this._submitEvent&&(t=this._submitEvent({})),t.success&&this.close()},e.exports=i},function(e,t,i){"use strict";var s=i(15),n=function(e){s.apply(this,[e||document.getElementById("dialog-new-smile")]),this.form=this.dom.querySelector("form"),this.btn=this.form.querySelector('input[type="submit"]');var t=this.refresh.bind(this),i=this.refreshFile.bind(this);if(this.form.url.addEventListener("change",i),this.form.w.addEventListener("change",t),this.form.h.addEventListener("change",t),this.current_uploader="link",this.uploaders={file:this.form.querySelector(".file-uploader"),link:this.form.querySelector(".link-uploader")},this.uploaders.file&&this.uploaders.file.addEventListener("change",i),this.form.uploader)for(var n=0;n<this.form.uploader.length;n++)this.form.uploader[n].addEventListener("change",this._setUploaderEvent.bind(this));this._bindEvents()};n.prototype=Object.create(s.prototype),n.prototype.constructor=n,n.prototype._setUploaderEvent=function(e){this.setUploader(e.target.value)},n.prototype.setUploader=function(e){e!=this.current_uploader&&this.uploaders[e]&&(this.uploaders[this.current_uploader].style.display="none",this.uploaders[e].style.display="",this.current_uploader=e,this.refreshFile())},n.prototype.clearPreview=function(){var e=this.form,t=e.querySelector(".new-smile-preview");t.src="data:image/gif;base64,R0lGODdhAQABAIABAP///+dubiwAAAAAAQABAAACAkQBADs=",t.width=0,t.height=0,e.w.value="",e.h.value=""},n.prototype.setPreviewUrl=function(e){var t=this.form,i=t.querySelector(".new-smile-preview"),s=document.createElement("img");s.onload=function(){i.src=s.src,i.width=s.width,i.height=s.height,t.w.value=s.width,t.h.value=s.height},s.onerror=this.clearPreview.bind(this),s.src=e},n.prototype.refreshFile=function(){var e=this.form,t=e.querySelector(".new-smile-preview");if("link"==this.current_uploader){if(t.src==e.url.value)return;if(e.url.value.length<9)return void this.clearPreview();this.setPreviewUrl(e.url.value)}else if("file"==this.current_uploader){if(!e.file.files||!e.file.files[0])return void this.clearPreview();var i=new FileReader;i.onload=function(){this.setPreviewUrl(i.result)}.bind(this),i.onerror=function(){this.clearPreview()}.bind(this),i.readAsDataURL(e.file.files[0])}},n.prototype.refresh=function(){var e=this.form,t=e.querySelector(".new-smile-preview"),i=t.width/t.height,s=e.save_aspect.checked,n=parseInt(e.w.value);!isNaN(n)&&n>0&&t.width!=n&&(t.width=n,s&&(t.height=Math.round(n/i),e.h.value=t.height));var o=parseInt(e.h.value);!isNaN(o)&&o>0&&t.height!=o&&(t.height=o,s&&(t.width=Math.round(o*i),e.w.value=t.width))},n.prototype.onsubmit=function(){if(this._submitEvent){var e,t=this.form,i=parseInt(t.w.value),s=parseInt(t.h.value),n=function(e){this.btn.disabled=!1,e.success?this.close():this.error(e.error)}.bind(this);"link"==this.current_uploader?e=this._submitEvent({url:t.url.value,w:i,h:s,onend:n}):"file"==this.current_uploader&&(e=this._submitEvent({file:t.file.files?t.file.files[0]:null,w:i,h:s,onend:n})),e.success?this.btn.disabled=!0:this.error(e.error)}},e.exports=n},function(e,t,i){"use strict";var s=i(15),n=function(e){s.apply(this,[e||document.getElementById("dialog-import-userscript")]),this.form=this.dom.querySelector("form"),this.btn=this.form.querySelector('input[type="submit"]'),this._bindEvents()};n.prototype=Object.create(s.prototype),n.prototype.constructor=n,n.prototype.onsubmit=function(){if(this._submitEvent){var e=function(e){(e.notice||e.error)&&alert(e.notice||e.error),this.btn.disabled=!1,this.close()}.bind(this),t=this._submitEvent({form:this.form,onend:e});t.success?this.btn.disabled=!0:this.error(t.error)}},n.prototype.open=function(e){this.form.file.value="",this.btn.disabled=!1,s.prototype.open.apply(this,arguments)},e.exports=n},function(e,t,i){"use strict";var s=i(15),n=function(e){s.apply(this,[e||document.getElementById("dialog-save")]),this.processingElement=this.dom.querySelector(".processing"),this.savedElement=this.dom.querySelector(".saved"),this.beginElement=this.processingElement.querySelector(".processing-begin"),this.endElement=this.processingElement.querySelector(".processing-end"),this.smileCurrentElement=this.beginElement.querySelector(".smile-current"),this.smilesCountElement=this.beginElement.querySelector(".smiles-count"),this._bindEvents(),this.mode="begin"};n.prototype=Object.create(s.prototype),n.prototype.constructor=n,n.prototype.open=function(e){this.mode!=e.mode&&(console.log(this.mode,"->",e.mode),this.mode=e.mode,this.beginElement.style.display="begin"==this.mode?"":"none",this.endElement.style.display="saving"==this.mode?"":"none",this.processingElement.style.display="saved"==this.mode?"none":"",this.savedElement.style.display="saved"==this.mode?"":"none","saved"==this.mode!=this.dom.classList.contains("smp-saved")&&this.dom.classList.toggle("smp-saved")),"begin"==this.mode?(this.smileCurrentElement.textContent=e.current+1,this.smilesCountElement.textContent=e.count):"saved"==this.mode&&(this.savedElement.querySelector(".smp-id").textContent=e.savedData.smilepack_id,this.savedElement.querySelector(".smp-url").href=e.savedData.download_url,this.savedElement.querySelector(".smp-view-url").href=e.savedData.view_url,this.savedElement.querySelector(".smp-view-url").textContent=e.savedData.view_url),s.prototype.open.apply(this,arguments)},e.exports=n}]);