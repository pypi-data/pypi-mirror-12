(function(a,b){"use strict";var c=a.$;function d(){}a.task_events=new d();function e(){function d(a){var b;if(a.task.cur_item)a.task.cur_item.close_view_form();if(a.item_type==="report")a.print_report(false);else{b=c("#content");b.empty();a.task.cur_item=a;a.view(b);}}function e(e){var f;c("#title").html('Jam.py demo application');if(e.safe_mode){c("#user-info").text(e.user_info.role_name+' '+e.user_info.user_name);c('#log-out').show().click(function(a){a.preventDefault();e.logout();});}f=[e.journals,e.reports,e.catalogs];c("#taskmenu").show();for(var g=0;g<f.length;g++)c("#menu").append(c('<li></li>').append(c('<a href="#"></a>').text(f[g].item_caption).data('group',f[g])));c('#menu').on('click','a',(function(a){var b=c("#submenu"),d=c(this).data('group'),e;a.preventDefault();if(d){b.empty();c("#menu > li").removeClass('active');c(this).parent().addClass('active');for(var f=0;f<d.items.length;f++){e=d.items[f];if(e.visible&&e.can_view())b.append(c('<li></li>').append(c('<a href="#"></a>').text(e.item_caption).data('item',e)));}}}));c('#submenu').on('click','a',(function(a){var b=c(this).data('item');a.preventDefault();c("#submenu > li").removeClass('active');c(this).parent().addClass('active');d(b);}));c("#menu").append(c('<li></li>').append(c('<a href="#">About</a>').click(function(a){a.preventDefault();e.information(c('<a href="http://jam-py.com/" target="_blank"><h3>Jam.py</h3></a>'+'<h3>Demo application</h3>'+' with <a href="http://chinookdatabase.codeplex.com/" target="_blank">Chinook Database</a>'+'<p>by Andrew Yushev</p>'+'<p>2014</p>'),{title:'Jam.py framework',margin:0,text_center:true,buttons:{"OK":b},center_buttons:true});})));c(a).on('resize',function(){v(e);});}function f(a){var b,d,e=[];if(a.reports){for(var f=0;f<a.reports.length;f++)if(a.reports[f].can_view())e.push(a.reports[f]);if(e.length){b=a.view_form.find("#report-btn ul");for(var f=0;f<e.length;f++){d=c('<li><a href="#">'+e[f].item_caption+'</a></li>');d.find('a').data('report',e[f]);d.on('click','a',function(a){a.preventDefault();c(this).data('report').print_report(false);});b.append(d);}}else a.view_form.find("#report-btn").hide();}else a.view_form.find("#report-btn").hide();}function g(b){var d,e={height:480,word_wrap:false,sortable:true};if(!b.master)b.auto_loading=true;if(b.view_form.hasClass('modal'))b.view_options.width=960;else{b.view_form.find(".modal-body").css('padding',0);b.view_form.find(".view-title #title-left").append(c('<h4>'+b.item_caption+'<h4>'));e.height=c(a).height()-c('body').height()-40;}if(b.can_create())b.view_form.find("#new-btn").on('click.task',function(){b.insert_record();});else b.view_form.find("#new-btn").attr('disabled','disabled');if(b.can_edit())b.view_form.find("#edit-btn").on('click.task',function(){b.edit_record();});else b.view_form.find("#edit-btn").attr('disabled','disabled');if(b.can_delete())b.view_form.find("#delete-btn").on('click.task',function(){b.delete_record();});else b.view_form.find("#delete-btn").attr('disabled','disabled');b.view_form.on('contextmenu.task','.jam-table.'+b.item_name+' td',function(a){var c=b.view_form.find('#context_menu');b.task.show_context_menu(b.view_form.find('#context_menu'),a);});f(b);if(b.init_table)b.init_table(b,e);b.view_table=b.create_table(b.view_form.find(".view-table"),e);}function h(a){j(a.view_form);a.open();}function i(a){var b={col_count:1};a.edit_options.width=560;if(a.init_inputs)a.init_inputs(a,b);a.create_inputs(a.edit_form.find(".edit-body"),b);a.edit_form.find("#cancel-btn").attr("tabindex",101).on('click.task',function(b){a.cancel_edit(b);return false;});a.edit_form.find("#ok-btn").attr("tabindex",100).on('click.task',function(){a.apply_record();});}function j(a){a.find(".modal-footer button.btn").each(function(){if(c(this).outerWidth()<100)c(this).outerWidth(100);});}function k(a){if(a.details_active)a.eachDetail(function(a){a.update_controls();});else a.open_details();j(a.edit_form);t(a);}function l(a){var b=true;if(a.is_changing())if(a.modified){a.yesNoCancel(task.language.save_changes,function(){a.apply_record();},function(){a.cancel_edit();});b=false;}else a.cancel();return b;}function m(a){a.filter_form.title=a.item_caption+' - filter';a.create_filter_inputs(a.filter_form.find(".edit-body"));a.filter_form.find("#cancel-btn").attr("tabindex",101).on('click.task',function(){a.close_filter();});a.filter_form.find("#ok-btn").attr("tabindex",100).on('click.task',function(){a.apply_filter();});}function n(a){j(a.filter_form);}function o(a){a.create_param_inputs(a.params_form.find(".edit-body"));a.params_form.find("#cancel-btn").attr("tabindex",101).on('click.task',function(){a.close_params_form();});a.params_form.find("#ok-btn").attr("tabindex",100).on('click.task',function(){a.process_report();});}function p(a){j(a.params_form);}function q(a,b){if(b.keyCode===45&&b.ctrlKey===true){b.preventDefault();a.insert_record();}else if(b.keyCode===46&&b.ctrlKey===true){b.preventDefault();a.delete_record();}}function r(a,b){if(b.keyCode===13&&b.ctrlKey===true){b.preventDefault();a.edit_form.find("#ok-btn").focus();a.apply_record();}}function s(b){var d;if(b.view_table){d=b.view_table.height()+c(a).height()-c('body').height()-40;if(d<200)d=200;b.view_table.height(d);b.view_table.resize();}}function t(b,d){var e,f,g;if(b.edit_form&&b.edit_table){e=b.edit_form.height();f=c(a).height();if(d||e>f-20){g=b.edit_table.height()-(e-f)-20;if(g>450)g=450;if(g<200)g=200;b.edit_table.height(g);b.edit_table.resize();}}}var u;function v(a){var b=a.cur_item;clearTimeout(u);u=setTimeout(function(){if(b){s(b);t(b,true);}},100);}this.viewItem=d;this.on_page_loaded=e;this.create_print_btns=f;this.on_before_show_view_form=g;this.on_after_show_view_form=h;this.on_before_show_edit_form=i;this.expand_buttons=j;this.on_after_show_edit_form=k;this.on_edit_form_close_query=l;this.on_before_show_filter_form=m;this.on_after_show_filter_form=n;this.on_before_show_params_form=o;this.on_after_show_params_form=p;this.on_view_keyup=q;this.on_edit_keyup=r;this.resize_view_table=s;this.resize_edit_table=t;this.resize=v;}a.task_events.events1=new e();function f(){function a(a){var d,e;if(a.default_field){if(a.lookup_field&&a.lookup_field.value){a.view_form.find(".view-title #title-left").append(c('<p><a href="#" id="cur_value">'+a.lookup_field.lookup_text+'</a></p>')).css('padding-top','12px');a.view_form.find("#cur_value").click(function(){var b=a.view_form.find("#cur_value").text();a.view_form.find('#input-find').val(b);a.search(a.default_field.field_name,b);});}e=a.view_form.find(".view-title input");e.on('input',function(){e.css('font-weight','normal');var b={},f=c(this);clearTimeout(d);d=setTimeout(function(){a.search(a.default_field.field_name,f.val());e.css('font-weight','bold');},500);});e.keydown(function(b){var c=(b.keyCode?b.keyCode:b.which);if(c===13)b.preventDefault();else if(c===40){a.view_form.find(".inner-table").focus();b.preventDefault();}});a.view_form.on('keydown',function(a){var c=(a.keyCode?a.keyCode:a.which);if(b(c)||c===32||c===8)if(!e.is(":focus")){if(c!==8)e.val('');e.focus();}});}else a.view_form.find("#title-right .form-inline").hide();}function b(a){if(a>=65&&a<=90||a>=186&&a<=192||a>=219&&a<=222)return true;}function d(a){setTimeout(function(){a.view_form.find(".view-title input").focus();},0);}this.on_before_show_view_form=a;this.isCharCode=b;this.on_after_show_view_form=d;}a.task_events.events2=new f();function g(){function a(a){var b;a.extension='pdf';if(a.params_form){b=a.params_form.find('select');if(b&&b.val())a.extension=b.val();}}this.on_before_print_report=a;}a.task_events.events5=new g();function h(){function a(a,b){b.sortable=false;}this.init_table=a;}a.task_events.events15=new h();function i(){function b(a){a.invoicedate.value=new Date();a.taxrate.value=5;}function d(b,d){d.height=c(a).height()-c('body').height()-200-40;if(d.height<200)d.height=200;d.show_footer=true;}function e(a){var b=new Date();b.setDate(b.getDate()-365);a.filters.invoicedate1.value=b;a.calculating=false;a.details_active=true;a.detail_table=a.invoice_table.create_table(a.view_form.find(".view-detail"),{height:200,dblclick_edit:false,column_width:{"track":"60%"}});a.view_form.find("#filter-btn").click(function(){a.create_filter_form();});}function f(a){if(a.view_form){a.view_form.find(".view-title #title-right").html('<h5 class="pull-right">'+a.get_status_text()+'<h5>');g(a);}}function g(a){var b=a.copy();b.assign_filters(a);b.open({fields:['subtotal','tax','total'],funcs:{subtotal:'sum',tax:'sum',total:'sum'}},function(){var c=a.view_form.find('.dbtable.'+a.item_name+' tfoot');b.eachField(function(a){c.find('div.'+a.field_name).css('text-align','right').css('color','black').text(a.display_text);});});}function h(a,b){b.col_count=2;}function i(a){a.edit_options.width=1050;a.edit_table=a.invoice_table.create_table(a.edit_form.find(".edit-detail"),{height:400,tabindex:90,editable:true,editable_fields:['quantity'],sortable:true,column_width:{"track":"60%"}});a.edit_form.find("#new-btn").attr("tabindex",92).on('click.task',function(){a.invoice_table.append_record();});a.edit_form.find("#edit-btn").attr("tabindex",91).on('click.task',function(){a.invoice_table.edit_record();});a.edit_form.find("#delete-btn").attr("tabindex",90).on('click.task',function(){a.invoice_table.delete_record();});}function j(a){if(a.field_name==='customer')return a.owner.firstname.lookup_text+' '+a.lookup_text;}function k(a,b){if(a.field_name==='taxrate')m(a.owner,true);}function l(a){a.amount.value=a.round(a.quantity.value*a.unitprice.value,2);a.tax.value=a.round(a.amount.value*a.owner.taxrate.value/100,2);a.total.value=a.amount.value+a.tax.value;}function m(a,b){var c,d,e,f;if(!a.calculating){a.calculating=true;try{c=0;d=0;e=0;a.invoice_table.disable_controls();f=a.invoice_table.rec_no;try{a.invoice_table.each(function(a){if(b){a.edit();l(a);a.post();}c+=a.amount.value;d+=a.tax.value;e+=a.total.value;});}finally{a.invoice_table.rec_no=f;a.invoice_table.enable_controls();}a.subtotal.value=c;a.tax.value=d;a.total.value=e;if(b)a.invoice_table.update_controls();}finally{a.calculating=false;}}}function n(a,b){if(b.keyCode===45&&b.ctrlKey===true){b.preventDefault();a.invoice_table.append_record();}else if(b.keyCode===46&&b.ctrlKey===true){b.preventDefault();a.invoice_table.delete_record();}}this.on_after_append=b;this.init_table=d;this.on_before_show_view_form=e;this.on_filter_applied=f;this.calc_footer=g;this.init_inputs=h;this.on_before_show_edit_form=i;this.on_get_field_text=j;this.on_field_changed=k;this.calc_total=l;this.calculate=m;this.on_edit_keyup=n;}a.task_events.events16=new i();function j(){function a(a){a.id.value=a.task.invoices.id.value;}this.on_before_print_report=a;}a.task_events.events19=new j();function k(){function a(a){var b=new Date();if(!a.invoicedate1.value){a.invoicedate1.value=new Date(b.getFullYear()-1,b.getMonth(),b.getDate());a.invoicedate2.value=b;}}this.on_before_show_params_form=a;}a.task_events.events20=new k();function l(){function a(a){a.owner.calculate(a.owner);}function b(a,b){var c=a.owner;if(a.field_name==='quantity'||a.field_name==='unitprice')c.owner.calc_total(c);else if(a.field_name==='track'&&b){c.quantity.value=1;c.unitprice.value=b.unitprice.value;}}function c(a){a.owner.calculate(a.owner);}function d(a){if(a.is_new())a.track.select_from_view_form();}this.on_after_post=a;this.on_field_changed=b;this.on_after_delete=c;this.on_after_show_edit_form=d;}a.task_events.events18=new l();})(window);