(function(){window.Djblets=window.Djblets||{};Djblets.Config={};Djblets.Config.ListItems=Backbone.Collection.extend({initialize:function(models,options){this.options=options},fetch:function(options){this.trigger("fetching");Backbone.Collection.prototype.fetch.call(this,options)}});Djblets.Config.ListItem=Backbone.Model.extend({defaults:{text:null,editURL:null,showRemove:false,canRemove:true,loading:false,removeLabel:gettext("Remove")},initialize:function(options){options=options||{};this.actions=options.actions||[];if(this.get("showRemove")){this.actions.push({id:"delete",label:this.get("removeLabel"),danger:true,enabled:this.get("canRemove")})}}});Djblets.Config.List=Backbone.Model.extend();Djblets.Config.ListItemView=Backbone.View.extend({tagName:"li",className:"config-forms-list-item",iconBaseClassName:"djblets-icon",actionHandlers:{},template:_.template(["<% if (editURL) { %>",'<a href="<%- editURL %>"><%- text %></a>',"<% } else { %>","<%- text %>","<% } %>"].join("")),initialize:function(){this.listenTo(this.model,"actionsChanged",this.render);this.listenTo(this.model,"request",this.showSpinner);this.listenTo(this.model,"sync",this.hideSpinner);this.listenTo(this.model,"destroy",this.remove);this.$spinnerParent=null;this.$spinner=null},render:function(){this.$el.empty().append(this.template(this.model.attributes));this.addActions(this.getActionsParent());return this},remove:function(){this.$el.fadeOut("normal",_.bind(Backbone.View.prototype.remove,this))},getActionsParent:function(){return this.$el},showSpinner:function(){if(this.$spinner){return}this.$spinner=$("<span/>").addClass("config-forms-list-item-spinner").prependTo(this.$spinnerParent).hide().css("visibility","visible").fadeIn().css("display","inline-block")},hideSpinner:function(){if(!this.$spinner){return}this.$spinner.fadeOut("slow",_.bind(function(){this.$spinner.remove();this.$spinner=null},this))},addActions:function($parentEl){var $actions=$("<span/>").addClass("config-forms-list-item-actions");_.each(this.model.actions,function(action){var $action=this._buildActionEl(action).appendTo($actions);if(action.children){if(action.label){$action.append(" &#9662;")}$action.click(_.bind(function(){_.defer(_.bind(this._showActionDropdown,this,action,$action))},this))}},this);this.$spinnerParent=$actions;$actions.prependTo($parentEl)},_showActionDropdown:function(action,$action){var actionPos=$action.position(),$pane=$("<ul/>").addClass("action-menu").move(actionPos.left+$action.getExtents("m","l"),actionPos.top+$action.outerHeight(),"absolute").click(function(e){e.stopPropagation()});_.each(action.children,function(childAction){$("<li/>").append(this._buildActionEl(childAction)).appendTo($pane)},this);$pane.appendTo($action.parent());$(document).one("click",function(){$pane.remove()})},_buildActionEl:function(action){var actionHandlerName=action.enabled!==false?this.actionHandlers[action.id]:null,checkboxID,$action,$result;if(action.type==="checkbox"){checkboxID=_.uniqueId("action_check");$action=$("<input/>").attr({type:"checkbox",id:checkboxID});$result=$("<span/>").append($action).append($("<label/>").attr("for",checkboxID).text(action.label));if(action.propName){$action.bindProperty("checked",this.model,action.propName)}if(actionHandlerName){$action.change(_.bind(this[actionHandlerName],this))}}else{$action=$result=$('<a class="btn"/>').text(action.label||"");if(action.iconName){$action.append($("<span/>").addClass(this.iconBaseClassName).addClass(this.iconBaseClassName+"-"+action.iconName))}if(actionHandlerName){$action.click(_.bind(this[actionHandlerName],this))}}if(action.id){$action.addClass("config-forms-list-action-"+action.id)}if(action.danger){$action.addClass("danger")}if(action.enabled===false){$action.attr("disabled","disabled");$result.addClass("disabled")}return $result}});Djblets.Config.ListView=Backbone.View.extend({tagName:"ul",className:"config-forms-list",defaultItemView:Djblets.Config.ListItemView,initialize:function(options){var collection=this.model.collection;this.ItemView=options.ItemView||this.defaultItemView;this.once("rendered",function(){this.listenTo(collection,"add",this._addItem);this.listenTo(collection,"remove",this._removeItem);this.listenTo(collection,"reset",this._renderItems)},this)},getBody:function(){return this.$el},render:function(){this.$listBody=this.getBody();this._renderItems();this.trigger("rendered");return this},_addItem:function(item){var view=new this.ItemView({model:item});this.$listBody.append(view.render().$el)},_removeItem:function(item,collection,options){this.$listBody.children().eq(options.index).remove()},_renderItems:function(){this.$listBody.empty();this.model.collection.each(this._addItem,this)}});Djblets.Config.PagesView=Backbone.View.extend({initialize:function(){this.router=new Backbone.Router({routes:{":pageID":"page"}});this.listenTo(this.router,"route:page",this._onPageChanged);this._$activeNav=null;this._$activePage=null;this._preserveMessages=true},render:function(){this._$pageNavs=this.$(".config-forms-side-nav li");this._$pages=this.$(".config-forms-page-content > .page");this._$activeNav=this._$pageNavs.eq(0).addClass("active");this._$activePage=this._$pages.eq(0).addClass("active");Backbone.history.start({root:window.location});return this},_onPageChanged:function(pageID){this._$activeNav.removeClass("active");this._$activePage.removeClass("active");this._$activeNav=this._$pageNavs.filter(":has(a[href=#"+pageID+"])").addClass("active");this._$activePage=$("#page_"+pageID).addClass("active");if(!this._preserveMessages){$("#messages").remove()}this._preserveMessages=false}});Djblets.Config.TableItemView=Djblets.Config.ListItemView.extend({tagName:"tr",template:_.template(["<td>","<% if (editURL) { %>",'<a href="<%- editURL %>"><%- text %></a>',"<% } else { %>","<%- text %>","<% } %>","</td>"].join("")),getActionsParent:function(){return this.$("td:last")}});Djblets.Config.TableView=Djblets.Config.ListView.extend({tagName:"table",defaultItemView:Djblets.Config.TableItemView,render:function(){var $body=this.getBody();if($body.length===0){this.$el.append("<tbody/>")}return _super(this).render.call(this)},getBody:function(){return this.$("tbody")}})}).call(this);