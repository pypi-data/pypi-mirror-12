{"version":3,"sources":["editor_image_upload.coffee"],"names":[],"mappings":"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","file":"editor_image_upload.js","sourceRoot":"/source/","sourcesContent":["###\n  Markdown editor image upload, should be loaded before $.editor()\n  requires: util.js\n###\n\n$ = jQuery\n\n\nclass EditorImageUpload\n\n  defaults:\n    csrfToken: \"csrf_token\",\n    target: \"target url\",\n    placeholderText: \"uploading {image_name}\"\n\n  constructor: (el, options) ->\n    @el = $(el)\n    @options = $.extend {}, @defaults, options\n    @inputFile = $(\"<input/>\", {type: \"file\", accept: \"image/*\"})\n    do @setUp\n\n  setUp: ->\n    if not window.FormData?\n      return\n\n    @inputFile.on 'change', @sendFile\n\n    # TODO: fixme, having multiple editors\n    # in the same page would open several\n    # dialogs on box-image click\n    $boxImage = $(\".js-box-image\")\n    $boxImage.on 'click', @openFileDialog\n    $boxImage.on 'click', @stopClick\n\n  sendFile: =>\n    file = @inputFile.get(0).files[0]\n    placeholder = @addPlaceholder file\n    formData = @buildFormData file\n\n    post = $.ajax {\n      url: @options.target,\n      data: formData,\n      processData: false,\n      contentType: false,\n      type: 'POST'\n    }\n\n    post.done (data) =>\n      if \"url\" of data\n        @addImage data, file, placeholder\n      else\n        @addError data, placeholder\n\n    post.fail (jqxhr, textStatus, error) =>\n      @addStatusError textStatus, error, placeholder\n\n    return\n\n  addPlaceholder: (file) =>\n    placeholder = $.format \"![#{ @options.placeholderText }]()\", {image_name: file.name, }\n    @el.val @el.val() + placeholder\n    return placeholder\n\n  buildFormData: (file) =>\n    formData = new FormData()\n    formData.append 'csrfmiddlewaretoken', @options.csrfToken\n    formData.append 'image', file\n    return formData\n\n  addImage: (data, file, placeholder) =>\n    imageTag = $.format \"![{name}]({url})\", {name: file.name, url: data.url}\n    @textReplace placeholder, imageTag\n\n  addError: (data, placeholder) =>\n    error = JSON.stringify data\n    @textReplace placeholder, \"![#{ error }]()\"\n\n  addStatusError: (textStatus, error, placeholder) =>\n    errorTag = $.format \"![error: {code} {error}]()\", {code: textStatus, error: error}\n    @textReplace placeholder, errorTag\n\n  textReplace: (find, replace) =>\n    @el.val @el.val().replace(find, replace)\n    return\n\n  openFileDialog: =>\n    @inputFile.trigger 'click'\n    return\n\n  stopClick: (e) ->\n    do e.preventDefault\n    do e.stopPropagation\n    do e.stopImmediatePropagation\n    return\n\n\n$.fn.extend\n  editor_image_upload: (options) ->\n    @each ->\n      if not $(@).data 'plugin_editor_image_upload'\n        $(@).data 'plugin_editor_image_upload', new EditorImageUpload(@, options)\n\n$.fn.editor_image_upload.EditorImageUpload = EditorImageUpload"]}