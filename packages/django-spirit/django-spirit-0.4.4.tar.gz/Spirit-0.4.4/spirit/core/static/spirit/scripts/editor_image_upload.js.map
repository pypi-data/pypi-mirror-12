{"version":3,"sources":["editor_image_upload.coffee"],"names":[],"mappings":"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","file":"editor_image_upload.js","sourceRoot":"/source/","sourcesContent":["###\n    Markdown editor image upload, should be loaded before $.editor()\n    requires: util.js\n###\n\n$ = jQuery\n\n\nclass EditorImageUpload\n\n    defaults: {\n        csrfToken: \"csrf_token\",\n        target: \"target url\",\n        placeholderText: \"uploading {image_name}\"\n    }\n\n    constructor: (el, options) ->\n        @el = $(el)\n        @options = $.extend({}, @defaults, options)\n        @inputFile = $(\"<input/>\", {type: \"file\", accept: \"image/*\"})\n        @setUp()\n\n    setUp: ->\n        if not window.FormData?\n            return\n\n        @inputFile.on('change', @sendFile)\n\n        # TODO: fixme, having multiple editors\n        # in the same page would open several\n        # dialogs on box-image click\n        $boxImage = $(\".js-box-image\")\n        $boxImage.on('click', @openFileDialog)\n        $boxImage.on('click', @stopClick)\n\n    sendFile: =>\n        file = @inputFile.get(0).files[0]\n        placeholder = @addPlaceholder(file)\n        formData = @buildFormData(file)\n\n        post = $.ajax({\n            url: @options.target,\n            data: formData,\n            processData: false,\n            contentType: false,\n            type: 'POST'\n        })\n\n        post.done((data) =>\n            if \"url\" of data\n                @addImage(data, file, placeholder)\n            else\n                @addError(data, placeholder)\n        )\n\n        post.fail((jqxhr, textStatus, error) =>\n            @addStatusError(textStatus, error, placeholder)\n        )\n\n        return\n\n    addPlaceholder: (file) =>\n        placeholder = $.format(\"![#{ @options.placeholderText }]()\", {image_name: file.name, })\n        @el.val(@el.val() + placeholder)\n        return placeholder\n\n    buildFormData: (file) =>\n        formData = new FormData()\n        formData.append('csrfmiddlewaretoken', @options.csrfToken)\n        formData.append('image', file)\n        return formData\n\n    addImage: (data, file, placeholder) =>\n        imageTag = $.format(\"![{name}]({url})\", {name: file.name, url: data.url})\n        @textReplace(placeholder, imageTag)\n\n    addError: (data, placeholder) =>\n        error = JSON.stringify(data)\n        @textReplace(placeholder, \"![#{ error }]()\")\n\n    addStatusError: (textStatus, error, placeholder) =>\n        errorTag = $.format(\"![error: {code} {error}]()\", {code: textStatus, error: error})\n        @textReplace(placeholder, errorTag)\n\n    textReplace: (find, replace) =>\n        @el.val(@el.val().replace(find, replace))\n        return\n\n    openFileDialog: =>\n        @inputFile.trigger('click')\n        return\n\n    stopClick: (e) ->\n        e.preventDefault()\n        e.stopPropagation()\n        e.stopImmediatePropagation()\n        return\n\n\n$.fn.extend\n    editor_image_upload: (options) ->\n        @each( ->\n            if not $(@).data('plugin_editor_image_upload')\n                $(@).data('plugin_editor_image_upload', new EditorImageUpload(@, options))\n        )\n\n$.fn.editor_image_upload.EditorImageUpload = EditorImageUpload\n"]}