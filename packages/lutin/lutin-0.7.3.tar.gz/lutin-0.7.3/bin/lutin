#!/usr/bin/python
##
## @author Edouard DUPIN
##
## @copyright 2012, Edouard DUPIN, all right reserved
##
## @license APACHE v2.0 (see license file)
##

# for path inspection:
import sys
import os
import lutin.debug as debug
import lutin.arg as arguments
import lutin.host as host
import lutin.module as module
import lutin.target as target
import lutin.env as env
import lutin.multiprocess as multiprocess

myArgs = arguments.LutinArg()
myArgs.add(arguments.ArgDefine("h", "help", desc="Display this help"))
myArgs.add(arguments.ArgDefine("H", "HELP", desc="Display this help (with all compleate information)"))
myArgs.add_section("option", "Can be set one time in all case")
myArgs.add(arguments.ArgDefine("v", "verbose", list=[["0","None"],["1","error"],["2","warning"],["3","info"],["4","debug"],["5","verbose"],["6","extreme_verbose"]], desc="display makefile debug level (verbose) default =2"))
myArgs.add(arguments.ArgDefine("C", "color", desc="Display makefile output in color"))
myArgs.add(arguments.ArgDefine("B", "force-build", desc="Force the rebuild without checking the dependency"))
myArgs.add(arguments.ArgDefine("P", "pretty", desc="Print the debug has pretty display"))
myArgs.add(arguments.ArgDefine("j", "jobs", haveParam=True, desc="Specifies the number of jobs (commands) to run simultaneously"))
myArgs.add(arguments.ArgDefine("s", "force-strip", desc="Force the stripping of the compile elements"))
myArgs.add(arguments.ArgDefine("w", "warning", desc="Store warning in a file build file"))

myArgs.add_section("properties", "keep in the sequency of the cible")
myArgs.add(arguments.ArgDefine("t", "target", haveParam=True, desc="Select a target (by default the platform is the computer that compile this) To know list : 'lutin.py --list-target'"))
myArgs.add(arguments.ArgDefine("c", "compilator", list=[["clang",""],["gcc",""]], desc="Compile with clang or Gcc mode (by default gcc will be used)"))
myArgs.add(arguments.ArgDefine("", "compilator-version", haveParam=True, desc="With travis we need to specify the name of the version if we want to compile with gcc 4.9 ==> --compilator-version=4.9"))
myArgs.add(arguments.ArgDefine("m", "mode", list=[["debug",""],["release",""]], desc="Compile in release or debug mode (default release)"))
myArgs.add(arguments.ArgDefine("a", "arch", list=[["auto","Automatic choice"],["arm","Arm processer"],["x86","Generic PC : AMD/Intel"],["ppc","Power PC"]], desc="Architecture to compile"))
myArgs.add(arguments.ArgDefine("b", "bus", list=[["auto","Automatic choice"],["32","32 bits"],["64","64 bits"]], desc="Adressing size (Bus size)"))
myArgs.add(arguments.ArgDefine("p", "package", desc="Disable the package generation (usefull when just compile for test on linux ...)"))
myArgs.add(arguments.ArgDefine("g", "gcov", desc="Enable code coverage intrusion in code"))
myArgs.add(arguments.ArgDefine("", "simulation", desc="Simulater mode (availlable only for IOS)"))
myArgs.add(arguments.ArgDefine("", "list-target", desc="List all availlables targets ==> for auto completion"))
myArgs.add(arguments.ArgDefine("", "list-module", desc="List all availlables module ==> for auto completion"))

myArgs.add_section("cible", "generate in order set")
localArgument = myArgs.parse()

"""
	display the help of this makefile
"""
def usage(full=False):
	color = debug.get_color_set()
	# generic argument displayed : 
	myArgs.display()
	print("		All target can finish with '?clean' '?dump' '?gcov' ... ?action (@ can replace ?)" )
	print("		" + color['green'] + "all" + color['default'])
	print("			build all (only for the current selected board) (bynary and packages)")
	print("		" + color['green'] + "clean" + color['default'])
	print("			clean all (same as previous)")
	print("		" + color['green'] + "dump" + color['default'])
	print("			Dump all the module dependency and properties")
	print("		" + color['green'] + "gcov" + color['default'])
	print("			Parse all the code of the library with the gcov resolution")
	listOfAllModule = module.list_all_module_with_desc()
	for mod in listOfAllModule:
		data_print = "		"
		if full == False:
			if    mod["type"][:6] == "BINARY":
				data_print += color['blue']
				if mod["sub-type"] == "":
					data_print += "* "
				elif mod["sub-type"] == "TEST":
					data_print += "T "
				elif mod["sub-type"] == "TOOLS":
					data_print += "U "
				elif mod["sub-type"] == "SAMPLE":
					data_print += "S "
				else:
					data_print += "  "
			elif mod["type"] == "PACKAGE":
				data_print += color['red'] + "# "
			elif    mod["type"][:7] == "LIBRARY":
				data_print += color['yellow'] + "  "
			else:
				data_print += color['default'] + "  "
		else:
			data_print += color['green']
		data_print += mod["name"] + color['default']
		if full == False:
			data_print += "\r\t\t\t\t\t\t\t"
			if mod["license"] != "":
				data_print += color['yellow'] + " [" + mod["license"] + "]" + color['default']
			if mod["version"] != []:
				version_ID = tools.version_to_string(mod["version"])
				data_print += color['blue'] + " (" + version_ID + ")" + color['default']
			"""
			if     mod["compagny-type"] != "" \
			   and mod["compagny-name"] != "":
				data_print += color['purple'] + " " + mod["compagny-type"] + "/" + mod["compagny-name"] + color['default']
			elif mod["compagny-name"] != "":
				data_print += color['purple'] + " " + mod["compagny-name"] + color['default']
			"""
		
		print(data_print)
		if mod["description"] != "":
			print("			" + mod["description"])
		if full == True:
			if mod["type"] != "":
				print("				Type:     " + mod["type"])
			if mod["sub-type"] != "":
				print("				Sub-Type: " + mod["sub-type"])
			if mod["version"] != []:
				version_ID = ""
				for id in mod["version"]:
					if len(version_ID) != 0:
						if type(id) == str:
							version_ID+="-"
						else:
							version_ID+="."
					version_ID += str(id)
				print("				version:  " + color['blue'] + version_ID + color['default'])
			if     mod["compagny-type"] != "" \
			   and mod["compagny-name"] != "":
				print("				compagny: " + color['purple'] + mod["compagny-type"] + "/" + mod["compagny-name"] + color['default'])
			elif mod["compagny-name"] != "":
				print("				compagny: " + color['purple'] + mod["compagny-name"] + color['default'])
			if mod["license"] != "":
				print("				license:  " + color['yellow'] + mod["license"] + color['default'])
			if mod["maintainer"] != []:
				print("				maintainers:")
				for elem in mod["maintainer"]:
					print("					" + str(elem))
	print("	ex: " + sys.argv[0] + " all --target=Android all -t Windows -m debug all")
	exit(0)

# preparse the argument to get the verbose element for debug mode
def parseGenericArg(argument, active):
	if argument.get_option_name() == "help":
		if active==False:
			usage()
		return True
	if argument.get_option_name() == "HELP":
		if active==False:
			usage(True)
		return True
	if argument.get_option_name() == "list-module":
		if active==False:
			listOfModule = module.list_all_module()
			retValue = ""
			for moduleName in listOfModule:
				if retValue != "":
					retValue += " "
				retValue += moduleName
			print(retValue)
			exit(0)
		return True
	if argument.get_option_name() == "list-target":
		if active==False:
			listOfTarget = target.list_all_target()
			retValue = ""
			for targetName in listOfTarget:
				if retValue != "":
					retValue += " "
				retValue += targetName
			print(retValue)
			exit(0)
		return True
	elif argument.get_option_name()=="jobs":
		if active==True:
			multiprocess.set_core_number(int(argument.get_arg()))
		return True
	elif argument.get_option_name() == "verbose":
		if active==True:
			debug.set_level(int(argument.get_arg()))
		return True
	elif argument.get_option_name() == "color":
		if active==True:
			debug.enable_color()
		return True
	elif argument.get_option_name() == "force":
		if active==True:
			env.set_force_mode(True)
		return True
	elif argument.get_option_name() == "pretty":
		if active==True:
			env.set_print_pretty_mode(True)
		return True
	elif argument.get_option_name() == "force-strip":
		if active==True:
			env.set_force_strip_mode(True)
		return True
	elif argument.get_option_name() == "warning":
		if active==True:
			env.set_warning_mode(True)
		return True
	return False

# parse default unique argument:
for argument in localArgument:
	parseGenericArg(argument, True)


import lutin


import lutin.host as lutinHost
import lutin.tools as lutinTools

#available target : Linux / MacOs / Windows / Android ...
targetName = host.OS
config = {
	"compilator":"gcc",
	"mode":"release",
	"bus-size":"auto",
	"arch":"auto",
	"generate-package":True,
	"simulation":False,
	"gcov":False,
	"compilator-version":""
	}
# load the default target :
my_target = None
actionDone=False
# parse all argument
for argument in localArgument:
	if parseGenericArg(argument, False) == True:
		continue
	elif argument.get_option_name() == "compilator-version":
		config["compilator-version"] = argument.get_arg()
	elif argument.get_option_name() == "package":
		config["generate-package"]=False
	elif argument.get_option_name() == "simulation":
		config["simulation"]=True
	elif argument.get_option_name() == "gcov":
		config["gcov"]=True
	elif argument.get_option_name() == "bus":
		config["bus-size"]=argument.get_arg()
	elif argument.get_option_name() == "arch":
		config["arch"]=argument.get_arg()
	elif argument.get_option_name() == "compilator":
		if config["compilator"] != argument.get_arg():
			debug.debug("change compilator ==> " + argument.get_arg())
			config["compilator"] = argument.get_arg()
			#remove previous target
			my_target = None
	elif argument.get_option_name() == "target":
		# No check input ==> this will be verify automaticly chen the target will be loaded
		if targetName != argument.get_arg():
			targetName = argument.get_arg()
			debug.debug("change target ==> '" + targetName + "' & reset mode : gcc&release")
			#reset properties by defauult:
			config = {
			             "compilator":"gcc",
			             "mode":"release",
			             "bus-size":"auto",
			             "arch":"auto",
			             "generate-package":True,
			             "simulation":False,
			             "gcov":False,
			             "compilator-version":""
			          }
			#remove previous target
			my_target = None
	elif argument.get_option_name() == "mode":
		if config["mode"] != argument.get_arg():
			config["mode"] = argument.get_arg()
			debug.debug("change mode ==> " + config["mode"])
			#remove previous target
			my_target = None
	else:
		if argument.get_option_name() != "":
			debug.warning("Can not understand argument : '" + argument.get_option_nName() + "'")
			usage()
		else:
			#load the target if needed :
			if my_target == None:
				my_target = target.load_target(targetName, config)
			my_target.build(argument.get_arg())
			actionDone=True

# if no action done : we do "all" ...
if actionDone==False:
	#load the target if needed :
	if my_target == None:
		my_target = target.load_target(targetName, config)
	my_target.build("all")

# stop all started threads;
multiprocess.un_init()


