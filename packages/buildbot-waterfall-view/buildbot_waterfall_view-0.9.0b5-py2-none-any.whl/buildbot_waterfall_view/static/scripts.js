(function(){var t,e,r=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};e=function(){function t(){return["ui.router","ngAnimate","common","guanlecoja.ui"]}return t}(),t=function(){function t(t,r,i,n,a,l,s,o,c,u){var d,h;this.$scope=t,this.$window=i,this.$log=n,this.$modal=a,this.buildbotService=l,this.dataService=o,this.bbSettingsService=u,e=this,this.loading=!0,this.s=this.bbSettingsService.getSettingsGroup("Waterfall"),this.c={margin:{top:15,right:20,bottom:20,left:70},gap:30,scaling:this.s.scaling_waterfall.value,minColumnWidth:this.s.min_column_width_waterfall.value,timeFormat:"%x^%H:%M",limit:this.s.lazy_limit_waterfall.value,threshold:this.s.idle_threshold_waterfall.value,buildidBackground:this.s.number_background_waterfall.value},d=this.buildbotService.all("builders").bind(this.$scope),h=this.buildbotService.some("builds",{limit:this.c.limit,order:"-complete_at"}).bind(this.$scope),r.all([s.get(),d,h]).then(function(t){return function(e){var r,i;return t.d3=e[0],t.builders=e[1],t.builds=e[2],t.scale=new c(t.d3),t.groups=t.dataService.getGroups(t.builders,t.builds,t.c.threshold),t.dataService.addStatus(t.builders),t.waterfall=t.d3.select(".waterfall"),t.container=t.waterfall.select(".svg-container"),t.header=t.waterfall.select(".header-content"),t.createElements(),t.render(),t.loading=!1,t.$scope.$watch(function(){return t.waterfall.style("width")},function(e,r){return e!==r?t.render():void 0},!0),angular.element(t.$window).bind("resize",function(){return t.render()}),t.$scope.$watch("builds",function(e){return null!=e&&t.builds.length!==e.length?(t.builds=e,t.groups=t.dataService.getGroups(t.builders,t.builds,t.c.threshold),t.dataService.addStatus(t.builders),t.render()):void 0},!0),r=t.container.node().parentNode,i=function(){return t.getHeight()-r.scrollTop<1e3?(angular.element(r).unbind("scroll"),t.loadMore().then(function(e){return null!=e&&t.builds.length!==e.length?angular.element(r).bind("scroll",i):angular.element(r).unbind("scroll")})):void 0},angular.element(r).bind("scroll",i),t.$window.onkeydown=function(e){return 107===e.keyCode?(e.preventDefault(),t.incrementScaleFactor(),t.render()):109===e.keyCode?(e.preventDefault(),t.decrementScaleFactor(),t.render()):void 0}}}(this))}var e;return e=null,t.prototype.incrementScaleFactor=function(){return this.c.scaling*=1.5,this.s.scaling_waterfall.value*=1.5,this.bbSettingsService.save()},t.prototype.decrementScaleFactor=function(){return this.c.scaling/=1.5,this.s.scaling_waterfall.value/=1.5,this.bbSettingsService.save()},t.prototype.loadMore=function(){return this.buildbotService.some("builds",{limit:this.builds.length+this.c.limit,order:"-complete_at"}).bind(this.$scope)},t.prototype.createElements=function(){return this.container.selectAll("*").remove(),this.header.selectAll("*").remove(),this.chart=this.container.append("svg").append("g").attr("transform","translate("+this.c.margin.left+", "+this.c.margin.top+")").attr("class","chart"),this.header=this.header.append("svg").append("g").attr("transform","translate("+this.c.margin.left+", "+this.getHeaderHeight()+")").attr("class","header")},t.prototype.getWidth=function(){return parseInt(this.container.style("width").replace("px",""),10)},t.prototype.setWidth=function(){var t,e,r;return this.c.minColumnWidth>0?(t=(this.$window.innerWidth-this.c.margin.right-this.c.margin.left)/this.builders.length,e=this.c.minColumnWidth<=t,r=e?"100%":""+(this.builders.length*this.c.minColumnWidth+this.c.margin.right+this.c.margin.left)+"px",this.waterfall.select(".inner-content").style("width",r),this.waterfall.select(".header-content").style("width",r)):this.$log.error("Bad column width configuration\n	 min: "+this.c.minColumnWidth)},t.prototype.getHeight=function(){return parseInt(this.container.style("height").replace("px",""),10)},t.prototype.setHeight=function(){var t,e,r,i,n,a;for(e=-this.c.gap,a=this.groups,i=0,n=a.length;n>i;i++)t=a[i],e+=t.max-t.min+this.c.gap;return r=e*this.c.scaling+this.c.margin.top+this.c.margin.bottom,r<parseInt(this.waterfall.style("height").replace("px",""),10)&&this.loadMore(),this.container.style("height",""+r+"px")},t.prototype.getInnerWidth=function(){var t;return t=this.getWidth(),t-this.c.margin.left-this.c.margin.right},t.prototype.getInnerHeight=function(){var t;return t=this.getHeight(),t-this.c.margin.top-this.c.margin.bottom},t.prototype.getHeaderHeight=function(){return parseInt(this.header.style("height").replace("px",""),10)},t.prototype.getResultClassFromThing=function(t){var e;if(!t.complete&&t.started_at>=0)e="pending";else switch(t.results){case 0:e="success";break;case 1:e="warnings";break;case 2:e="failure";break;case 3:e="skipped";break;case 4:e="exception";break;case 5:e="cancelled";break;default:e="unknown"}return e},t.prototype.drawXAxis=function(){var t,r,i,n,a,l;return n=this.scale.getX(this.builders,this.getInnerWidth()),r=this.scale.getBuilderName(this.builders),this.header.select(".axis.x").remove(),t=this.header.append("g").attr("class","axis x"),t.selectAll("*").remove(),a=this.d3.svg.axis().scale(n).orient("top").tickFormat(r),l=t.call(a),i=function(t){var r,i;return i=e.d3.select(this.parentNode),r=i.append("a").attr("xlink:href","#/builders/"+t),r.node().appendChild(this)},l.selectAll("text").style("text-anchor","start").attr("transform","translate(0, -5) rotate(-60)").attr("dy",".75em").each(i),l.selectAll("line").data(this.builders).attr("transform","rotate(90)").attr("x1",0).attr("x2",0).attr("y1",n.rangeBand()/2).attr("y2",-n.rangeBand()/2).attr("class",e.getResultClassFromThing).classed("stroke",!0)},t.prototype.ticks=[],t.prototype.addTicks=function(t){var e;return e=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight()),this.ticks=this.ticks.concat([e(t.complete_at),e(t.started_at)])},t.prototype.removeTicks=function(){return this.ticks=[]},t.prototype.drawYAxis=function(){var t,i,n,a,l,s,o,c,u,d,h,p;for(a=this.d3.scale.linear(),c=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight()),this.chart.select(".axis.y").remove(),t=this.chart.append("g").attr("class","axis y"),t.attr("transform","translate("+this.waterfall.node().scrollLeft+", 0)"),this.waterfall.on("scroll",function(){return u.attr("transform","translate("+this.scrollLeft+", 0)")}),t.append("rect").attr("x",-this.c.margin.left).attr("y",-this.c.margin.top).attr("width",this.c.margin.left).attr("height",this.getHeight()).style("fill","#fff"),o=this.ticks,p=this.groups,d=0,h=p.length;h>d;d++)n=p[d],o=o.concat([c(n.min),c(n.max)]);return s=function(t){return function(e){var r,i,n;return n=c.invert(e),r=new Date(1e3*n),i=t.d3.time.format(t.c.timeFormat),i(r)}}(this),u=this.d3.svg.axis().scale(a).orient("left").tickValues(o).tickFormat(s),u=t.call(u),l=function(){var t,r,i,n,l,s,o,c;for(t=e.d3.select(this),n=t.text().split("^"),t.text(""),c=[],a=s=0,o=n.length;o>s;a=++s)i=n[a],r=t.append("tspan").text(i),0!==a?(l=t.attr("x"),c.push(r.attr("x",l).attr("dy",10*a))):c.push(void 0);return c},u.selectAll("text").each(l),i=function(t){return function(e){return r.call(t.ticks,e)>=0?"2, 5":"2, 1"}}(this),u.selectAll(".tick").append("line").attr("x2",this.getInnerWidth()).attr("stroke-dasharray",i)},t.prototype.drawBuilds=function(){var t,r,i,n,a,l;return a=this.scale.getX(this.builders,this.getInnerWidth()),l=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight()),this.chart.selectAll(".builder").remove(),t=this.chart.selectAll(".builder").data(this.builders).enter().append("g").attr("class","builder").attr("transform",function(t){return"translate("+a(t.builderid)+", 0)"}),i=function(t){return t.builds},n=function(t){return t.buildid},r=t.selectAll(".build").data(i,n).enter().append("g").attr("class","build").attr("transform",function(t){return"translate(0, "+l(t.complete_at)+")"}),r.append("rect").attr("class",e.getResultClassFromThing).attr("width",a.rangeBand()).attr("height",function(t){return l(t.started_at)-l(t.complete_at)}).classed("fill",!0),this.c.buildidBackground&&r.append("rect").attr("y",-15).attr("width",a.rangeBand()).attr("height",15).style("fill","#ccc"),r.append("text").attr("class","id").attr("x",a.rangeBand()/2).attr("y",-3).text(function(t){return t.number}),r.on("mouseover",this.mouseOver).on("mousemove",this.mouseMove).on("mouseout",this.mouseOut).on("click",this.click)},t.prototype.mouseOver=function(t){var r,i,n,a,l,s,o;return r=e.d3.select(this),n=e.d3.mouse(this),e.addTicks(t),e.drawYAxis(),a=e.d3.select(this.parentNode),this.parentNode.appendChild(this),a.each(function(){return this.parentNode.appendChild(this)}),s=t.builderid<e.builders.length/2,i=40,l=function(){return s?"20,0 0,"+i/2+" 20,"+i+" 170,"+i+" 170,0":"150,0 170,"+i/2+" 150,"+i+" 0,"+i+" 0,0"},o=r.append("g").attr("class","svg-tooltip").attr("transform","translate("+n[0]+", "+n[1]+")").append("g").attr("class","tooltip-content").attr("transform","translate("+(s?5:-175)+", "+-i/2+")"),o.append("polygon").attr("points",l()),t.all("steps").bind(e.$scope).then(function(t){var r;return i=15*t.length+7,o.transition().duration(100).attr("transform","translate("+(s?5:-175)+", "+-i/2+")").select("polygon").attr("points",l()),r=function(t){var e;return e=new Date(1e3*(t.complete_at-t.started_at)),e>0?"("+e/1e3+"s)":""},o.selectAll(".buildstep").data(t).enter().append("g").attr("class","buildstep").append("text").attr("y",function(t,e){return 15*(e+1)}).attr("x",s?30:10).attr("class",e.getResultClassFromThing).classed("fill",!0).transition().delay(100).text(function(t,e){return""+(e+1)+". "+t.name+" "+r(t)})})},t.prototype.mouseMove=function(){var t,r;return t=e.d3.select(this),r=e.d3.mouse(this),t.select(".svg-tooltip").attr("transform","translate("+r[0]+", "+r[1]+")")},t.prototype.mouseOut=function(){var t;return t=e.d3.select(this),e.removeTicks(),e.drawYAxis(),t.selectAll(".svg-tooltip").remove()},t.prototype.click=function(t){var r;return r=e.$modal.open({templateUrl:"waterfall_view/views/modal.html",controller:"waterfallModalController as modal",windowClass:"modal-small",resolve:{selectedBuild:function(){return t}}})},t.prototype.render=function(){var t,e,r;return t=this.container.node().parentNode,r=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight()),e=r.invert(t.scrollTop),this.setWidth(),this.setHeight(),this.drawBuilds(),this.drawXAxis(),this.drawYAxis(),r=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight()),t.scrollTop=r(e)},t}(),angular.module("waterfall_view",new e).controller("waterfallController",["$scope","$q","$window","$log","$modal","buildbotService","d3Service","dataService","scaleService","bbSettingsService",t])}).call(this),function(){var t;t=function(){function t(t){t.addSettingsGroup({name:"Waterfall",caption:"Waterfall related settings",items:[{type:"integer",name:"scaling_waterfall",caption:"Scaling factor",default_value:1},{type:"integer",name:"min_column_width_waterfall",caption:"Minimum column width (px)",default_value:40},{type:"integer",name:"lazy_limit_waterfall",caption:"Lazy loading limit",default_value:40},{type:"integer",name:"idle_threshold_waterfall",caption:"Idle time threshold in unix time stamp (eg. 300 = 5 min)",default_value:300},{type:"bool",name:"number_background_waterfall",caption:"Build number background",default_value:!1}]})}return t}(),angular.module("waterfall_view").config(["bbSettingsServiceProvider",t])}.call(this),function(){var t;t=function(){function t(t,e){var r,i,n;i="waterfall",e.addGroup({name:i,caption:"Waterfall View",icon:"bar-chart-o",order:5}),r={group:i,caption:"Waterfall View"},n={controller:""+i+"Controller",controllerAs:"w",templateUrl:"waterfall_view/views/"+i+".html",name:i,url:"/"+i,data:r},t.state(n)}return t}(),angular.module("waterfall_view").config(["$stateProvider","glMenuServiceProvider",t])}.call(this),function(){var t;t=function(){function t(){}return t.prototype.getGroups=function(t,e,r){var i,n,a,l,s,o,c,u,d;for(e.sort(function(t,e){return t.buildid-e.buildid}),l=[],a=-1,s={groupid:0,time:0},o=0,u=t.length;u>o;o++)n=t[o],n.builds=[];for(c=0,d=e.length;d>c;c++)i=e[c],i.started_at-s.time>r&&++a,null==l[a]&&(l[a]={min:i.started_at}),s.groupid!==a&&(l[s.groupid].max=s.time),i.complete||(i.complete_at=Math.round(new Date/1e3)),i.groupid=s.groupid=a,t[i.builderid-1].builds.push(i),i.complete_at>s.time&&(s.time=i.complete_at);return l[s.groupid].max=s.time,l},t.prototype.addStatus=function(t){var e,r,i,n,a,l,s,o,c;for(c=[],n=0,l=t.length;l>n;n++){for(r=t[n],i=null,o=r.builds,a=0,s=o.length;s>a;a++)e=o[a],i=e,e.number>i.number&&(i=e);r.started_at=null!=i?i.started_at:void 0,r.complete=(null!=i?i.complete:void 0)||!1,c.push(r.results=null!=i?i.results:void 0)}return c},t}(),angular.module("waterfall_view").service("dataService",[t])}.call(this),function(){var t;t=function(){function t(t,e,r){this.$modalInstance=e,this.selectedBuild=r,t.$on("$stateChangeStart",function(t){return function(){return t.close()}}(this))}return t.prototype.close=function(){return this.$modalInstance.close()},t}(),angular.module("waterfall_view").controller("waterfallModalController",["$scope","$modalInstance","selectedBuild",t])}.call(this),function(){var t;t=function(){function t(){var t;return t=function(){function t(t){this.d3=t}return t.prototype.getX=function(t,e){return this.d3.scale.ordinal().domain(t.map(function(t){return t.builderid})).rangeRoundBands([0,e],e/(400*t.length))},t.prototype.getY=function(t,e,r){var i,n,a,l,s,o,c;for(i=r,n=i-(t.length-1)*e,a=0,o=0,c=t.length;c>o;o++)s=t[o],a+=s.max-s.min;return l=function(){function r(r){var l,o,c,u,d,h,p,g;for(c=[],l=d=0,p=t.length;p>d;l=++d){if(s=t[l],s.min<=r&&r<=s.max){for(c.push(r-s.min),u=0,h=0,g=c.length;g>h;h++)o=c[h],u+=o;return i-n/a*u-l*e}c.push(s.max-s.min)}return void 0}return r.invert=function(r){var l,o,c,u,d,h,p,g,m;for(u=[],o=h=0,g=t.length;g>h;o=++h){for(s=t[o],d=0,p=0,m=u.length;m>p;p++)c=u[p],d+=c;if(l=(i-r-o*e)*(a/n)-d+s.min,s.min<=l&&l<=s.max)return l;u.push(s.max-s.min)}return void 0},r}()},t.prototype.getBuilderName=function(t){return this.d3.scale.ordinal().domain(t.map(function(t){return t.builderid})).range(t.map(function(t){return t.name}))},t}()}return t}(),angular.module("waterfall_view").factory("scaleService",[t])}.call(this),angular.module("waterfall_view").run(["$templateCache",function(t){t.put("waterfall_view/views/waterfall.html",'<div class="waterfall"><div ng-show="w.loading" class="load-indicator"><div class="spinner"><i class="fa fa-circle-o-notch fa-spin fa-2x"></i><p>loading</p></div></div><div class="header"><div class="header-content"></div></div><div class="content"><div class="inner-content"><div class="svg-container"></div></div></div></div>'),t.put("waterfall_view/views/modal.html",'<!-- Show build summary for the selected build in a modal window--><div class="modal-header"><i ng-click="modal.close()" class="fa fa-times pull-right"></i><h4 class="modal-title">Build summary</h4></div><div class="modal-body"><buildsummary ng-if="modal.selectedBuild" buildid="modal.selectedBuild.buildid"></buildsummary></div>')}]);